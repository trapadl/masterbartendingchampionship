<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Competition Schedule - Master Bartending Championship</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Black&display=swap" rel="stylesheet" />
    <style>
      .content-section {
        max-width: 1000px;
        margin: 0 auto;
        padding: 1rem;
      }
      
      .schedule-table-wrapper {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        margin-top: 2rem;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 4px;
      }
      
      .schedule-table {
        width: 100%;
        border-collapse: collapse;
        min-width: 600px;
      }
      
      .schedule-table th,
      .schedule-table td {
        padding: 1rem;
        text-align: left;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }
      
      .schedule-table th {
        background: rgba(255, 255, 255, 0.1);
        color: #ffffff;
        font-weight: bold;
        white-space: nowrap;
      }
      
      .schedule-table td {
        color: #aaaaaa;
      }
      
      .category-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 4px;
        font-size: 0.85rem;
        white-space: nowrap;
      }
      
      .category-speed {
        background: #ff4444;
      }
      
      .category-traditional {
        background: #4444ff;
      }
      
      .category-flair {
        background: #44ff44;
      }
      
      .status-upcoming {
        color: #44ff44;
      }
      
      .status-registration {
        color: #ffff44;
      }

      .hidden {
        display: none;
      }

      @media (max-width: 768px) {
        .content-section {
          padding: 0.5rem;
        }
        
        .schedule-table th,
        .schedule-table td {
          padding: 0.75rem;
          font-size: 0.9rem;
        }
        
        .category-badge {
          padding: 0.2rem 0.5rem;
          font-size: 0.8rem;
        }
        
        h1, h2 {
          padding: 0 0.5rem;
        }
      }
    </style>
    <!-- Base URL detection script -->
    <script>
      // Initialize base URL detection
      window.getBaseUrl = function() {
        const pathSegments = window.location.pathname.split('/');
        if (pathSegments.length > 1 && pathSegments[1] === 'masterbartendingchampionship') {
          return '/masterbartendingchampionship/';
        }
        return '/';
      };
      
      window.getAbsolutePath = function(path) {
        const baseUrl = window.getBaseUrl();
        const cleanPath = path.startsWith('/') ? path.substring(1) : path;
        return `${baseUrl}${cleanPath}`;
      };
    </script>
    <script type="module" crossorigin src="/masterbartendingchampionship/assets/competition-Z8FdLNGg.js"></script>
    <link rel="modulepreload" crossorigin href="/masterbartendingchampionship/assets/countdown-DoZ-_L6Q.js">
    <link rel="stylesheet" crossorigin href="/masterbartendingchampionship/assets/countdown-DmaKE9B1.css">
  </head>
  <body>
    <div class="content">
      <header class="small-header">
        <nav class="menu-container" aria-label="Main Navigation">
          <ul class="menu">
            <li class="menu-item" data-submenu="legacy">Legacy Leaderboard</li>
            <li class="menu-item" data-submenu="mbc">MBC Leaderboard</li>
            <li class="menu-item" data-submenu="about">About</li>
            <li class="menu-item" data-submenu="upcoming">Upcoming Competitions</li>
            <li class="menu-item" data-submenu="entry">Entry</li>
          </ul>
          <div class="submenu-inline"></div>
        </nav>
      </header>

      <div class="page-content">
        <!-- Upcoming Competitions Section -->
        <div class="content-section">
          <h1>Competition Schedule</h1>
          <div class="schedule-table-wrapper">
            <table class="schedule-table" id="upcoming-competitions-table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Event</th>
                  <th>Category</th>
                  <th>Location</th>
                  <th>More Info</th>
                </tr>
              </thead>
              <tbody id="upcoming-competitions-body">
                <!-- Will be populated dynamically -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Past Competitions Section -->
        <div class="content-section">
          <h2>Past Competitions</h2>
          <div class="schedule-table-wrapper">
            <table class="schedule-table" id="past-competitions-table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Event</th>
                  <th>Category</th>
                  <th>Location</th>
                  <th>Results</th>
                </tr>
              </thead>
              <tbody id="past-competitions-body">
                <!-- Dynamically populated rows go here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- JavaScript to load competitions from Supabase -->

    <script>
// This script should be added at the end of competitionschedule.html
// before the closing </body> tag

document.addEventListener('DOMContentLoaded', async function() {
  // Helper function to format category badges
  function formatCategoryBadge(category) {
    // Normalize the category by trimming and lowercase
    const normalizedCategory = (category || 'legacy').trim().toLowerCase();
    
    // Create badge element
    const badge = document.createElement('span');
    badge.classList.add('category-badge');
    
    // Set class and text based on normalized category
    if (normalizedCategory === 'speed') {
      badge.classList.add('category-speed');
      badge.textContent = 'Speed';
    } else if (normalizedCategory === 'flair') {
      badge.classList.add('category-flair');
      badge.textContent = 'Flair';
    } else if (normalizedCategory === 'traditional' || normalizedCategory === 'legacy') {
      badge.classList.add('category-traditional');
      badge.textContent = 'Traditional';
    } else {
      // Handle any other category
      badge.textContent = category || 'Unknown';
    }
    
    return badge;
  }

  async function loadUpcomingCompetitions() {
    console.log('Loading upcoming competitions...');
    try {
      const { data: upcoming, error } = await supabase
        .from('legacy_competitions')
        .select('id, name, date, venue, category, more_info_link')
        .eq('status', 'upcoming')
        .order('date', { ascending: true });

      if (error) throw error;

      console.log('Upcoming competitions fetched:', upcoming);

      const tbody = document.getElementById('upcoming-competitions-body');
      if (!tbody) {
        console.error('Upcoming competitions tbody not found');
        return;
      }

      tbody.innerHTML = '';

      if (upcoming && upcoming.length > 0) {
        upcoming.forEach(comp => {
          const tr = document.createElement('tr');

          // Date
          const dateTd = document.createElement('td');
          dateTd.textContent = new Date(comp.date).toLocaleDateString();
          tr.appendChild(dateTd);

          // Event Name
          const eventTd = document.createElement('td');
          eventTd.textContent = comp.name;
          tr.appendChild(eventTd);

          // Category
          const categoryTd = document.createElement('td');
          categoryTd.appendChild(formatCategoryBadge(comp.category));
          tr.appendChild(categoryTd);

          // Venue
          const venueTd = document.createElement('td');
          venueTd.textContent = comp.venue;
          tr.appendChild(venueTd);

          // More Info (hyperlink)
          const infoTd = document.createElement('td');
          if (comp.more_info_link) {
            const link = document.createElement('a');
            link.href = comp.more_info_link;
            link.target = '_blank'; 
            link.rel = 'noopener noreferrer';
            link.textContent = 'see more';
            infoTd.appendChild(link);
          } else {
            infoTd.textContent = 'N/A';
          }
          tr.appendChild(infoTd);

          tbody.appendChild(tr);
        });
      } else {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 5;
        td.textContent = 'No upcoming competitions found';
        td.style.textAlign = 'center';
        tr.appendChild(td);
        tbody.appendChild(tr);
      }
    } catch (error) {
      console.error('Error loading upcoming competitions:', error);
    }
  }

  async function loadPastCompetitions() {
    console.log('Loading past competitions...');
    try {
      const { data: competitions, error } = await supabase
        .from('legacy_competitions')
        .select(`
          id,
          name,
          date,
          venue,
          category,
          status,
          legacy_results (
            placement,
            post_competition_rating,
            pre_competition_rating,
            bartender:bartenders ( full_name )
          )
        `)
        .eq('status', 'approved')
        .order('date', { ascending: false });

      if (error) throw error;

      console.log('Past competitions fetched:', competitions);

      const tbody = document.getElementById('past-competitions-body');
      if (!tbody) {
        console.error('Past competitions tbody not found');
        return;
      }

      tbody.innerHTML = '';

      if (competitions && competitions.length > 0) {
        competitions.forEach((comp) => {
          // Main row
          const mainRow = document.createElement('tr');

          // Date
          const dateTd = document.createElement('td');
          dateTd.textContent = new Date(comp.date).toLocaleDateString();
          mainRow.appendChild(dateTd);

          // Event
          const eventTd = document.createElement('td');
          eventTd.textContent = comp.name;
          mainRow.appendChild(eventTd);

          // Category
          const categoryTd = document.createElement('td');
          categoryTd.appendChild(formatCategoryBadge(comp.category));
          mainRow.appendChild(categoryTd);

          // Venue
          const venueTd = document.createElement('td');
          venueTd.textContent = comp.venue;
          mainRow.appendChild(venueTd);

          // Results toggle
          const resultsTd = document.createElement('td');
          const toggleBtn = document.createElement('button');
          toggleBtn.textContent = '▼';
          toggleBtn.style.cursor = 'pointer';
          resultsTd.appendChild(toggleBtn);
          mainRow.appendChild(resultsTd);

          // Sub-row (hidden by default)
          const subRow = document.createElement('tr');
          subRow.classList.add('hidden');

          const subCell = document.createElement('td');
          subCell.colSpan = 5;

          const subTable = document.createElement('table');
          subTable.style.width = '100%';
          subTable.style.marginTop = '0.5rem';

          const subThead = document.createElement('thead');
          subThead.innerHTML = `
            <tr>
              <th style="width: 10%">Placement</th>
              <th style="width: 40%">Bartender</th>
              <th style="width: 25%">Rating After</th>
              <th style="width: 25%">Change</th>
            </tr>
          `;
          subTable.appendChild(subThead);

          const subTbody = document.createElement('tbody');

          if (comp.legacy_results && comp.legacy_results.length > 0) {
            comp.legacy_results.forEach((r) => {
              const resultTr = document.createElement('tr');

              // Placement
              const placeTd = document.createElement('td');
              placeTd.textContent = r.placement;
              resultTr.appendChild(placeTd);

              // Bartender
              const bartenderTd = document.createElement('td');
              bartenderTd.textContent = r.bartender?.full_name || 'Unknown Bartender';
              resultTr.appendChild(bartenderTd);

              // Rating After
              const ratingTd = document.createElement('td');
              const ratingAfter = r.post_competition_rating ?? '?';
              ratingTd.textContent = ratingAfter.toFixed
                ? ratingAfter.toFixed(1)
                : ratingAfter;
              resultTr.appendChild(ratingTd);

              // Change
              const changeTd = document.createElement('td');
              const preRating = r.pre_competition_rating ?? ratingAfter;
              const diff = ratingAfter - preRating;
              const sign = diff >= 0 ? '+' : '';
              changeTd.textContent = `${sign}${diff.toFixed ? diff.toFixed(1) : diff}`;
              resultTr.appendChild(changeTd);

              subTbody.appendChild(resultTr);
            });
          } else {
            // No results
            const noResultsTr = document.createElement('tr');
            const noResultsTd = document.createElement('td');
            noResultsTd.colSpan = 4;
            noResultsTd.textContent = 'No results found.';
            noResultsTr.appendChild(noResultsTd);
            subTbody.appendChild(noResultsTr);
          }

          subTable.appendChild(subTbody);
          subCell.appendChild(subTable);
          subRow.appendChild(subCell);

          // Toggle event
          toggleBtn.addEventListener('click', () => {
            subRow.classList.toggle('hidden');
          });

          tbody.appendChild(mainRow);
          tbody.appendChild(subRow);
        });
      } else {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 5;
        td.textContent = 'No past competitions found';
        td.style.textAlign = 'center';
        tr.appendChild(td);
        tbody.appendChild(tr);
      }
    } catch (error) {
      console.error('Error loading past competitions:', error);
    }
  }

  // Load competitions on page load
  await loadUpcomingCompetitions();
  await loadPastCompetitions();
});

    </script>
  </body>
</html>