import{r as n,j as e}from"./main-Do236Ahx.js";import{s as y,c as B,O as A,a as R}from"./OrganizerSelect-BXb4Y9_J.js";const O=B("BartenderSelect"),D=({value:C,onSelect:j,placeholder:m="Select a bartender",initialLabel:S="",excludeIds:u=[]})=>{const[o,f]=n.useState(S),[h,b]=n.useState(!1),[w,t]=n.useState([]),[c,l]=n.useState(!1),[d,z]=n.useState(null);n.useEffect(()=>{if(!o.trim()){t([]);return}const g=setTimeout(async()=>{l(!0);try{let v=y.from("bartenders").select("id, full_name, is_approved").ilike("full_name",`%${o}%`).is("is_archived",!1);u.length>0&&(v=v.not("id","in",`(${u.join(",")})`));const{data:k,error:q}=await v.limit(5);if(q)throw q;t(k||[])}catch(v){O.error("Failed to load bartenders:",v),z("Failed to load bartenders")}finally{l(!1)}},300);return()=>clearTimeout(g)},[o,u.join(",")]);const N=i=>{f(i.full_name),b(!1),j(i)},s=async()=>{try{const{data:{user:i}}=await y.auth.getUser();if(!i)throw new Error("Please sign in to add a new bartender");const{data:g,error:v}=await y.from("bartenders").insert({full_name:o.trim(),rating:1500,rating_rd:350,rating_volatility:.06,is_profile_claimed:!1,is_approved:!1}).select().single();if(v)throw v;O.info("Created new bartender:",{id:g.id,name:g.full_name}),alert("New bartender created! Note: Bartenders need to be approved by an administrator before appearing on leaderboards."),f(g.full_name),b(!1),j(g)}catch(i){O.error("Error adding new bartender:",i),z(i.message)}};return e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",value:o,onChange:i=>{f(i.target.value),b(!0)},onClick:()=>b(!0),placeholder:m,className:"w-full p-2 bg-zinc-700 text-white rounded border border-gray-600"}),h&&(o.trim()||c||d)&&e.jsxs("div",{className:"absolute z-50 w-full mt-1 bg-zinc-800 rounded-md border border-gray-700 shadow-lg",children:[c&&e.jsx("div",{className:"p-2 text-gray-300 text-center",children:"Loading..."}),d&&e.jsx("div",{className:"p-2 text-red-400",children:d}),!c&&!d&&w.length>0&&e.jsxs("div",{children:[w.map(i=>e.jsx("div",{className:"p-2 hover:bg-zinc-700 cursor-pointer text-white",onClick:()=>N(i),children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{children:i.full_name}),i.is_approved===!1&&e.jsx("span",{className:"text-xs text-yellow-400 px-2 py-1 bg-zinc-800 rounded",children:"Pending"})]})},i.id)),e.jsx("div",{className:"border-t border-gray-700 mt-2"})]}),o.trim()&&e.jsxs("div",{className:"p-2 hover:bg-zinc-700 cursor-pointer text-white flex justify-between items-center",onClick:s,children:[e.jsxs("span",{children:['+ Add "',o.trim(),'" as new bartender']}),e.jsx("span",{className:"text-gray-400",children:"→"})]}),!c&&!d&&o.trim()&&w.length===0&&!d&&e.jsx("div",{className:"p-2 text-gray-300 text-center",children:"No matching bartenders found"})]})]})},P=({onSelect:C,placeholder:j="Search for competition"})=>{const[m,S]=n.useState(""),[u,o]=n.useState(!1),[f,h]=n.useState([]),[b,w]=n.useState(!1),[t,c]=n.useState(null);n.useEffect(()=>{if(!m.trim()){h([]);return}const z=setTimeout(async()=>{w(!0);try{const{data:N,error:s}=await y.from("legacy_competitions").select("id, name, date, venue").ilike("name",`%${m}%`).order("date",{ascending:!1}).limit(5);if(s)throw s;h(N||[])}catch(N){console.error("Error fetching competitions:",N),c("Failed to load competitions")}finally{w(!1)}},300);return()=>clearTimeout(z)},[m]);const l=()=>{C({name:m.trim(),isNew:!0}),S(m.trim()),o(!1)};return e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",value:m,onChange:d=>{S(d.target.value),o(!0)},onClick:()=>o(!0),placeholder:j,className:"w-full p-2 bg-zinc-700 text-white rounded border border-gray-600"}),u&&m.trim()&&e.jsxs("div",{className:"absolute z-50 w-full mt-1 bg-zinc-800 rounded-md border border-gray-700 shadow-lg max-h-60 overflow-y-auto",children:[b&&e.jsx("div",{className:"p-2 text-gray-300 text-center",children:"Loading..."}),t&&e.jsx("div",{className:"p-2 text-red-400",children:t}),!b&&!t&&f.length>0&&e.jsxs("div",{children:[f.map(d=>e.jsxs("div",{className:"p-2 hover:bg-zinc-700 cursor-pointer text-white",onClick:()=>{C(d),S(d.name),o(!1)},children:[e.jsx("div",{children:d.name}),e.jsxs("div",{className:"text-gray-400 text-sm",children:[new Date(d.date).toLocaleDateString()," - ",d.venue]}),e.jsx("hr",{className:"border-t border-gray-700 mt-2"})]},d.id)),e.jsx("div",{className:"border-t border-gray-700 mt-2"})]}),e.jsxs("div",{className:"p-2 hover:bg-zinc-700 cursor-pointer text-white flex justify-between items-center",onClick:l,children:[e.jsxs("span",{children:['+ Add "',m.trim(),'" as new competition']}),e.jsx("span",{className:"text-gray-400",children:"→"})]})]})]})},L=B("VenueSelect"),U=({value:C,onSelect:j,placeholder:m="Select a venue",initialLabel:S=""})=>{const[u,o]=n.useState(S),[f,h]=n.useState(!1),[b,w]=n.useState([]),[t,c]=n.useState(!1),[l,d]=n.useState(null);n.useEffect(()=>{if(!u.trim()){w([]);return}const i=setTimeout(async()=>{c(!0);try{const{data:g,error:v}=await y.from("venues").select("id, name, city, country").ilike("name",`%${u}%`).is("is_archived",!1).order("name").limit(5);if(v)throw v;w(g||[])}catch(g){L.error("Failed to load venues:",g),d("Failed to load venues")}finally{c(!1)}},300);return()=>clearTimeout(i)},[u]);const z=s=>{o(s.name),h(!1),j(s)},N=async()=>{try{const{data:{user:s}}=await y.auth.getUser();if(!s)throw new Error("Please sign in to add a new venue");const{data:i,error:g}=await y.from("venues").insert({name:u.trim(),created_by:s.id}).select().single();if(g)throw g;L.info("Created new venue:",{id:i.id,name:i.name}),o(i.name),h(!1),j(i)}catch(s){L.error("Error adding new venue:",s),d(s.message)}};return e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",value:u,onChange:s=>{o(s.target.value),h(!0)},onClick:()=>h(!0),placeholder:m,className:"w-full p-2 bg-zinc-700 text-white rounded border border-gray-600"}),f&&(u.trim()||t||l)&&e.jsxs("div",{className:"absolute z-50 w-full mt-1 bg-zinc-800 rounded-md border border-gray-700 shadow-lg",children:[t&&e.jsx("div",{className:"p-2 text-gray-300 text-center",children:"Loading..."}),l&&e.jsx("div",{className:"p-2 text-red-400",children:l}),!t&&!l&&b.length>0&&e.jsxs("div",{children:[b.map(s=>e.jsxs("div",{className:"p-2 hover:bg-zinc-700 cursor-pointer text-white",onClick:()=>z(s),children:[e.jsx("div",{children:s.name}),s.city&&s.country&&e.jsxs("div",{className:"text-gray-400 text-sm",children:[s.city,", ",s.country]})]},s.id)),e.jsx("div",{className:"border-t border-gray-700 mt-2"})]}),u.trim()&&e.jsxs("div",{className:"p-2 hover:bg-zinc-700 cursor-pointer text-white flex justify-between items-center",onClick:N,children:[e.jsxs("span",{children:['+ Add "',u.trim(),'" as new venue']}),e.jsx("span",{className:"text-gray-400",children:"→"})]}),!t&&!l&&u.trim()&&b.length===0&&!l&&e.jsx("div",{className:"p-2 text-gray-300 text-center",children:"No matching venues found"})]})]})},M=[{id:"state final",label:"State Final"},{id:"national final",label:"National Final"},{id:"global final",label:"Global Final"}],G=({onSuccess:C,onError:j})=>{const[m,S]=n.useState(!1),[u,o]=n.useState(""),[f,h]=n.useState([{id:"",position:""}]),[b,w]=n.useState(!1),[t,c]=n.useState({date:"",venue_id:"",venue_name:"",organizer_id:"",organizer_name:"",source_url:"",category:"legacy",country:"",round:"state final"}),[l,d]=n.useState(null),[z,N]=n.useState(!1),s=()=>{const{organizer_name:r,date:a,round:_,country:p}=t,E=(l==null?void 0:l.name)||"";if(!a||!r||!E||!_)return null;const x=new Date(a).getFullYear();return`${r} ${E} ${x} ${_} ${p||""}`.trim()},i=r=>{d(r),w(!(r!=null&&r.id)),r!=null&&r.id&&c(a=>({...a,date:r.date,venue_id:r.venue_id,venue_name:r.venue,organizer_id:r.organizer,category:r.category||"legacy",country:r.country||""}))},g=async r=>{try{const{data:a}=await y.from("organisers").select("organisation_name").eq("id",r.id).single();c(_=>({..._,organizer_id:r.id,organizer_name:(a==null?void 0:a.organisation_name)||""}))}catch(a){console.error("Error fetching organizer details:",a),o("Error fetching organizer details")}},v=r=>{c(a=>({...a,venue_id:r.id,venue_name:r.name}))},k=r=>({1:25,2:15,3:15,4:12,5:10,6:8,7:6,8:4,9:2,10:1})[r]||0,q=async r=>{r.preventDefault(),S(!0),o(""),N(!1);try{const{data:{user:a},error:_}=await y.auth.getUser();if(_)throw new Error("Authentication error");if(!a)throw new Error("Please sign in to submit results");if(b){if(!t.date)throw new Error("Date is required");if(!t.organizer_id)throw new Error("Organizer is required");if(!t.venue_id)throw new Error("Venue is required");if(!(l!=null&&l.name))throw new Error("Competition name is required");if(!t.round)throw new Error("Competition round is required")}let p;if(l!=null&&l.id)p=l.id;else{const x=s();if(!x)throw new Error("Unable to generate competition name - missing required fields");const{data:F,error:T}=await y.from("legacy_competitions").insert({name:x,date:t.date,venue:t.venue_name,venue_id:t.venue_id,organizer:t.organizer_id,category:t.category,country:t.country||null,created_by:a.id,status:"pending"}).select().single();if(T)throw T;p=F.id}const E=f.filter(x=>x.id&&x.position);if(E.length===0)throw new Error("At least one competitor with position is required");for(const x of E){const{error:F}=await y.from("legacy_results").insert({legacy_competition_id:p,bartender_id:x.id,placement:parseInt(x.position,10),points:k(parseInt(x.position,10)),status:"pending",created_by:a.id,competition_category:t.category});if(F)throw F}if(t.source_url){const{error:x}=await y.from("sources").insert({legacy_competition_id:p,url:t.source_url,created_by:a.id});if(x)throw x}N(!0),setTimeout(()=>{I(),C==null||C()},2e3)}catch(a){console.error("Submission error:",a),o(a.message),j==null||j(a.message)}finally{S(!1)}},I=()=>{c({date:"",venue_id:"",venue_name:"",organizer_id:"",organizer_name:"",source_url:"",category:"legacy",country:"",round:"state final"}),d(null),h([{id:"",position:""}]),w(!1),N(!1)},V=()=>{h(r=>[...r,{id:"",position:""}])},$=r=>{h(a=>a.filter((_,p)=>p!==r))};return e.jsxs("div",{className:"p-6 bg-zinc-800 rounded-lg",children:[e.jsx("h3",{className:"text-xl text-white mb-6",children:"Submit Competition Result"}),u&&e.jsx("div",{className:"error-message mb-4 p-3 bg-red-500/20 border border-red-500 rounded text-red-200",children:u}),z&&e.jsx("div",{className:"success-message mb-4 p-3 bg-green-500/20 border border-green-500 rounded text-green-200",children:"Competition result submitted successfully! Your submission will be reviewed by an administrator."}),e.jsxs("form",{onSubmit:q,className:"space-y-6",method:"POST",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"block text-white mb-2",children:"Competition *"}),e.jsx(P,{onSelect:i,placeholder:"Search or add competition"})]}),b&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"block text-white mb-2",children:"Organizer *"}),e.jsx(A,{onSelect:g,placeholder:"Select organizer"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"block text-white mb-2",children:"Venue *"}),e.jsx(U,{onSelect:v,placeholder:"Select or add venue"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"block text-white mb-2",children:"Round *"}),e.jsx("select",{value:t.round,onChange:r=>c({...t,round:r.target.value}),className:"w-full p-2 bg-zinc-700 text-white rounded border border-gray-600",required:!0,children:M.map(r=>e.jsx("option",{value:r.id,children:r.label},r.id))})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"block text-white mb-2",children:"Category *"}),e.jsxs("select",{value:t.category,onChange:r=>c({...t,category:r.target.value}),className:"w-full p-2 bg-zinc-700 text-white rounded border border-gray-600",required:!0,children:[e.jsx("option",{value:"legacy",children:"Legacy Competition"}),e.jsx("option",{value:"speed",children:"Speed"}),e.jsx("option",{value:"flair",children:"Flair"}),e.jsx("option",{value:"traditional",children:"Traditional"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"block text-white mb-2",children:"Country"}),e.jsxs("select",{value:t.country,onChange:r=>c({...t,country:r.target.value}),className:"w-full p-2 bg-zinc-700 text-white rounded border border-gray-600",children:[e.jsx("option",{value:"",children:"Select country"}),R.map(r=>e.jsx("option",{value:r,children:r},r))]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"block text-white mb-2",children:"Date *"}),e.jsx("input",{type:"date",value:t.date,onChange:r=>c({...t,date:r.target.value}),className:"w-full p-2 bg-zinc-700 text-white rounded border border-gray-600",required:!0})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"block text-white mb-2",children:"Source URL *"}),e.jsx("input",{type:"url",value:t.source_url,onChange:r=>c({...t,source_url:r.target.value}),className:"w-full p-2 bg-zinc-700 text-white rounded border border-gray-600",required:!0,placeholder:"Link to competition results"})]}),e.jsxs("div",{className:"competitors-section mt-8",children:[e.jsx("h3",{className:"text-lg text-white mb-4",children:"Competitors *"}),f.map((r,a)=>e.jsxs("div",{className:"competitor-entry mb-4 p-4 bg-zinc-700 rounded",children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"block text-white mb-2",children:"Competitor Name *"}),e.jsx(D,{onSelect:_=>{const p=[...f];p[a].id=_.id,h(p)},placeholder:"Search for competitor"})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"block text-white mb-2",children:"Position *"}),e.jsx("input",{type:"number",value:r.position,onChange:_=>{const p=[...f];p[a].position=_.target.value,h(p)},className:"w-full p-2 bg-zinc-600 text-white rounded border border-gray-500",required:!0,min:"1"})]}),a>0&&e.jsx("button",{type:"button",onClick:()=>$(a),className:"text-red-400 hover:text-red-300 px-4 py-2 border border-red-500 rounded hover:bg-red-500/20 transition-colors",children:"Remove Competitor"})]},a)),e.jsx("button",{type:"button",onClick:V,className:"w-full p-2 border border-gray-400 text-gray-300 rounded hover:bg-zinc-700 transition-colors",children:"Add Competitor"})]}),e.jsx("button",{type:"submit",disabled:m,className:"w-full p-3 bg-white text-black font-bold rounded hover:bg-zinc-200 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:m?"Submitting...":"Submit Result"})]})]})};export{D as B,G as R};
