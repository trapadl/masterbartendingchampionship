import{j as e,r as d,P as te,s as A,c as J,u as X,a as re,b as ae}from"./main-CyxRsl2n.js";import{s as S,l as se,c as ie}from"./OrganizerSelect-CUkPV8eR.js";import{B as ne,R as oe}from"./ResultForm-Bq_5-dFp.js";import{s as W}from"./toast-C2SFxo1r.js";import{E as le}from"./EventCarousel-CilQ-BEt.js";class ce{async retryQuery(u,l,h=2){for(let g=1;g<=h;g++)try{console.log(`[LeaderboardService] ${l} attempt ${g}/${h}`);const o=await u();return console.log(`[LeaderboardService] ${l} succeeded on attempt ${g}`),o}catch(o){if(console.warn(`[LeaderboardService] ${l} failed on attempt ${g}:`,o.message),g===h)throw o;const i=g===1?500:1e3;console.log(`[LeaderboardService] Retrying ${l} in ${i}ms...`),await new Promise(b=>setTimeout(b,i))}}async fetchLeaderboardData(){const u=Date.now();console.log(`[LeaderboardService] Starting fetchLeaderboardData at ${new Date().toISOString()}`);const l=Date.now()-performance.timeOrigin;document.readyState==="complete"&&l<1e3&&(console.log(`[LeaderboardService] Detected recent page load (${l}ms ago), adding minimal delay`),await new Promise(h=>setTimeout(h,50)));try{console.log(`[LeaderboardService] Starting database queries at ${Date.now()-u}ms`);try{const{data:t}=await S.auth.getSession();console.log(`[LeaderboardService] Session status: ${t.session?"authenticated":"anonymous"}`)}catch{console.warn("[LeaderboardService] Session check failed, proceeding with anonymous access")}const h=new Promise((t,r)=>setTimeout(()=>r(new Error(`Database query timeout after 8s - elapsed: ${Date.now()-u}ms`)),8e3));console.log(`[LeaderboardService] Starting parallel database queries at ${Date.now()-u}ms`);const[g,o]=await Promise.all([this.retryQuery(async()=>{const t=S.from("legacy_results").select(`
              id,
              legacy_competition_id,
              bartender_id,
              placement,
              points,
              status,
              competition_category,
              legacy_competitions!fk_lr_competition (
                id,
                name,
                date,
                category
              )
            `).eq("status","approved");return await Promise.race([t,h])},"legacy_results query"),this.retryQuery(async()=>{const t=S.from("bartenders").select(`
              id, 
              full_name,
              rating,
              rating_rd,
              rating_volatility,
              ranking,
              speed_rating,
              speed_rd,
              speed_volatility,
              speed_ranking,
              traditional_rating,
              traditional_rd,
              traditional_volatility,
              traditional_ranking,
              flair_rating,
              flair_rd,
              flair_volatility,
              flair_ranking
            `).eq("is_approved",!0).not("is_archived","eq",!0);return await Promise.race([t,h])},"bartenders query")]),{data:i,error:b}=g,{data:f,error:v}=o;if(console.log(`[LeaderboardService] Parallel queries completed at ${Date.now()-u}ms - results: ${(i==null?void 0:i.length)||0}, bartenders: ${(f==null?void 0:f.length)||0}`),b)throw b;if(v)throw v;const y={legacy:new Set,speed:new Set,traditional:new Set,flair:new Set};return i.forEach(t=>{var m;if(!t.bartender_id)return;let r=t.competition_category||"legacy";!t.competition_category&&((m=t.legacy_competitions)!=null&&m.category)&&(r=t.legacy_competitions.category),y[r]?y[r].add(t.bartender_id):y.legacy.add(t.bartender_id)}),{legacy:f.filter(t=>y.legacy.has(t.id)&&t.rating!=null).sort((t,r)=>(r.rating||0)-(t.rating||0)).map(t=>({id:t.id,name:t.full_name,rating:t.rating,rating_rd:t.rating_rd,points:Math.round(t.rating||0),img:'<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="7" r="4"/><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/></svg>'})),speed:f.filter(t=>y.speed.has(t.id)&&t.speed_rating!=null).sort((t,r)=>(r.speed_rating||0)-(t.speed_rating||0)).map(t=>({id:t.id,name:t.full_name,rating:t.speed_rating,rating_rd:t.speed_rd,points:Math.round(t.speed_rating||0),img:'<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="7" r="4"/><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/></svg>'})),traditional:f.filter(t=>y.traditional.has(t.id)&&t.traditional_rating!=null).sort((t,r)=>(r.traditional_rating||0)-(t.traditional_rating||0)).map(t=>({id:t.id,name:t.full_name,rating:t.traditional_rating,rating_rd:t.traditional_rd,points:Math.round(t.traditional_rating||0),img:'<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="7" r="4"/><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/></svg>'})),flair:f.filter(t=>y.flair.has(t.id)&&t.flair_rating!=null).sort((t,r)=>(r.flair_rating||0)-(t.flair_rating||0)).map(t=>({id:t.id,name:t.full_name,rating:t.flair_rating,rating_rd:t.flair_rd,points:Math.round(t.flair_rating||0),img:'<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="7" r="4"/><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/></svg>'}))}}catch(h){return se(h),{legacy:[],traditional:[],flair:[],speed:[]}}}}const de=new ce,me=e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-8 w-8 text-gray-400",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("circle",{cx:"12",cy:"7",r:"4"}),e.jsx("path",{d:"M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"})]}),V=10;function ge({data:s=[],type:u="legacy",filter:l="rating",currentPage:h=0,onPageChange:g,searchActive:o=!1,onHistoryClick:i=()=>{}}){const b=n=>Math.round(n.rating||0),f="Rating",v=o?0:h*V,y=o?s.slice(0,Math.min(50,s.length)):s.slice(v,v+V),t=o?1:Math.ceil(s.length/V),r=h<t-1,m=h>0,p=n=>n%2===0?"bg-zinc-850":"bg-zinc-800";return e.jsxs("div",{className:"overflow-x-auto rounded-lg shadow",children:[e.jsxs("table",{className:"leaderboard-table min-w-full divide-y divide-gray-700",children:[e.jsx("thead",{className:"bg-zinc-700",children:e.jsx("tr",{children:["Rank","Profile","Name",f].map(n=>e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider",children:n},n))})}),e.jsxs("tbody",{className:"divide-y divide-gray-700",children:[y.map((n,c)=>e.jsxs("tr",{className:`${p(c)} hover:bg-zinc-700 cursor-pointer`,onClick:()=>i(n),children:[e.jsx("td",{className:"px-4 py-3 text-sm text-gray-300",children:o?c+1:v+c+1}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("div",{className:"profile-pic h-10 w-10 bg-zinc-600 rounded-full flex items-center justify-center border border-gray-500 hover:border-white transition-colors",onClick:w=>{w.stopPropagation(),i(n)},title:`History for ${n.name}`,children:me})}),e.jsx("td",{className:"px-4 py-3 text-sm text-white",children:n.name}),e.jsx("td",{className:"px-4 py-3 text-sm text-white font-medium",children:b(n)})]},n.id||c)),!o&&(r||m)&&e.jsx("tr",{className:"pagination-row bg-zinc-800",children:e.jsx("td",{colSpan:"4",className:"text-center py-3 px-4 border-t border-gray-700",children:e.jsxs("div",{className:"pagination-controls flex justify-center gap-3",children:[m&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"pagination-button",onClick:()=>g(0),children:"Top 10"}),e.jsx("button",{className:"pagination-button",onClick:()=>g(h-1),children:"Previous 10"})]}),r&&e.jsx("button",{className:"pagination-button",onClick:()=>g(h+1),children:"Next 10"})]})})}),o&&s.length>50&&e.jsx("tr",{className:"bg-zinc-800",children:e.jsx("td",{colSpan:"4",className:"text-center py-3 px-4 text-gray-400 border-t border-gray-700",children:"Showing top 50 results. Please refine your search."})})]})]}),s.length===0&&e.jsx("div",{className:"text-center py-8 text-gray-400 italic",children:o?"No bartenders match your search.":"No competitors found yet."}),!o&&s.length>0&&y.length===0&&e.jsx("div",{className:"text-center py-8 text-gray-400 italic",children:"No more results on this page."})]})}const Y=({isOpen:s,onClose:u,title:l,children:h,maxWidth:g="max-w-xl"})=>{if(d.useEffect(()=>{const i=b=>{b.key==="Escape"&&u()};return s?(document.addEventListener("keydown",i),document.body.style.overflow="hidden"):document.body.style.overflow="",()=>{document.removeEventListener("keydown",i),document.body.style.overflow=""}},[s,u]),!s)return null;const o=i=>{i.target===i.currentTarget&&u()};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4 transition-opacity duration-300 ease-in-out",onClick:o,role:"dialog","aria-modal":"true","aria-labelledby":"modal-title",children:e.jsxs("div",{className:`bg-zinc-800 rounded-lg shadow-xl w-full ${g} max-h-[90vh] overflow-hidden flex flex-col`,children:[e.jsxs("div",{className:"flex justify-between items-center p-4 border-b border-gray-700 flex-shrink-0",children:[e.jsx("h2",{id:"modal-title",className:"text-xl font-semibold text-white",children:l||"Modal"}),e.jsx("button",{type:"button",onClick:u,className:"text-gray-400 hover:text-white text-2xl leading-none font-bold focus:outline-none p-1","aria-label":"Close modal",children:"×"})]}),e.jsx("div",{className:"p-6 overflow-y-auto flex-grow",children:h})]})})},Q=J("CompetitionHistoryModalContent"),ue=({bartenderId:s,bartenderName:u})=>{const[l,h]=d.useState([]),[g,o]=d.useState(!0),[i,b]=d.useState(null),[f,v]=d.useState(null);d.useEffect(()=>{(async()=>{if(!s){o(!1),b("Bartender ID is missing.");return}o(!0),b(null),Q.debug(`Fetching history for bartender ID: ${s}`);try{const{data:r,error:m}=await A.from("legacy_results").select(`placement,
             post_competition_rating,
             pre_competition_rating,
             legacy_competition_id,
             legacy_competitions!fk_lr_competition (
               id,
               name,
               date
             )`).eq("bartender_id",s).order("date",{ascending:!1,foreignTable:"legacy_competitions"});if(m)throw m;const{data:p,error:n}=await A.from("bartender_profiles").select("public_profile_slug").eq("bartender_id",s).eq("profile_visibility","public").single();!n&&(p!=null&&p.public_profile_slug)&&v(p.public_profile_slug),Q.debug("Fetched competition history",{bartenderId:s,resultCount:r==null?void 0:r.length}),h(r||[])}catch(r){Q.error("Error fetching competition history:",{bartenderId:s,error:r}),b(`Failed to load competition history: ${r.message}. Please try again.`)}finally{o(!1)}})()},[s]);const y=(t,r)=>t==null||r==null?"?":Math.round(r-t);return e.jsxs("div",{className:"competition-history-content max-h-[70vh] overflow-y-auto pr-2",children:[f&&e.jsx("div",{className:"mb-4 p-3 bg-blue-50 rounded-lg border border-blue-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{className:"text-blue-800 text-sm font-medium",children:["Want to see more about ",u,"?"]}),e.jsxs("a",{href:te.generatePublicProfileUrl(f),className:"inline-flex items-center gap-1 px-3 py-1 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 transition-colors",children:["View Profile",e.jsx("svg",{className:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M16 8v8m-4-5v5m-4-2v2m-2 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"})})]})]})}),g?e.jsxs("div",{className:"flex justify-center items-center p-8",children:[e.jsx("div",{className:"animate-spin h-6 w-6 border-4 border-white rounded-full border-t-transparent"}),e.jsx("span",{className:"ml-3 text-gray-300",children:"Loading history..."})]}):i?e.jsx("div",{className:"text-red-400 p-4 text-center bg-black/50 rounded border border-red-500",children:i}):l.length===0?e.jsxs("div",{className:"text-gray-400 p-6 text-center italic",children:["No competition history found for ",u,"."]}):e.jsxs("table",{className:"competition-history-table min-w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Date"}),e.jsx("th",{children:"Competition"}),e.jsx("th",{className:"text-center",children:"Placement"}),e.jsx("th",{className:"text-center",children:"Rating Change"})]})}),e.jsx("tbody",{children:l.map((t,r)=>{var w,x,j;const m=y(t.pre_competition_rating,t.post_competition_rating),p=(w=t.legacy_competitions)!=null&&w.date?new Date(t.legacy_competitions.date).toLocaleDateString("en-GB",{year:"numeric",month:"short",day:"numeric"}):"Unknown Date",n=m==="?"?"text-gray-400":m>0?"text-white":"text-gray-400",c=(x=t.legacy_competitions)!=null&&x.id?`${t.legacy_competitions.id}-${r}`:r;return e.jsxs("tr",{className:"even:bg-zinc-800 odd:bg-gradient-to-b from-zinc-800 to-zinc-900",children:[e.jsx("td",{className:"text-sm text-gray-300 whitespace-nowrap",children:p}),e.jsx("td",{className:"text-sm text-white",children:((j=t.legacy_competitions)==null?void 0:j.name)||"Unknown Competition"}),e.jsx("td",{className:"text-sm text-center text-gray-300",children:t.placement||"N/A"}),e.jsx("td",{className:`text-sm text-center font-medium ${n}`,children:m>=0?`+${m}`:m})]},c)})})]})]})};function q({id:s,title:u,type:l,data:h=[],page:g,filter:o,onPageChange:i,onFilterChange:b,showFilters:f=!1,showClaimButton:v=!1,hasPendingClaim:y=!1,comingSoon:t=!1,onClaimProfileClick:r,onSubmitResultClick:m}){const[p,n]=d.useState(""),[c,w]=d.useState(!1),[x,j]=d.useState(null),L=p.trim()?h.filter(_=>_.name.toLowerCase().includes(p.toLowerCase())):h,E=10,C=g*E,T=L.slice(C,C+E),M=_=>{j(_),w(!0)},F=()=>{j(null),w(!1)},z=_=>{n(_.target.value),g!==0&&i(l,0)},D=()=>n(""),O="px-4 py-2 rounded border transition-colors duration-200",I=`${O} bg-white text-black border-white hover:bg-zinc-200 hover:border-gray-200`,K=`${O} bg-transparent text-white border-gray-500 hover:bg-zinc-700`,G=`${O} bg-white text-black border-white`;return e.jsxs("div",{id:s,className:`leaderboard-container ${t?"coming-soon":""} mb-12`,children:[e.jsx("h2",{className:"text-2xl font-bold mb-4 text-white",children:u}),!t&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"search-container mb-4",children:[e.jsxs("div",{className:"relative w-full sm:w-1/4",children:[e.jsx("input",{type:"text",placeholder:"// search...",value:p,onChange:z,className:"w-full p-2 pl-10 bg-zinc-700 text-white rounded border border-gray-600 focus:border-gray-500 focus:outline-none"}),e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx("svg",{className:"h-5 w-5 text-gray-400",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:`M8 4a4 4 0 100 8 4 4 0 000-8zM2 \r
                       8a6 6 0 1110.89 3.476l4.817\r
                       4.817a1 1 0 01-1.414 \r
                       1.414l-4.816-4.816A6 6 0 012 8z`,clipRule:"evenodd"})})}),p&&e.jsx("button",{className:"absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-white",onClick:D,children:e.jsx("svg",{className:"h-5 w-5",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:`M10 18a8 8 0 100-16 8 8 0 000 \r
                         16zM8.707 7.293a1 1 0 00-1.414 \r
                         1.414L8.586 10l-1.293 1.293a1 1 \r
                         0 101.414 1.414L10 11.414l1.293 \r
                         1.293a1 1 0 001.414-1.414L11.414 \r
                         10l1.293-1.293a1 1 0 00-1.414-1.414L10 \r
                         8.586 8.707 7.293z`,clipRule:"evenodd"})})})]}),p&&L.length===0?e.jsxs("p",{className:"text-gray-400 text-sm mt-2",children:["No results for “",p,"”"]}):p?e.jsxs("p",{className:"text-gray-400 text-sm mt-2",children:["Found ",L.length," ",L.length===1?"result":"results"]}):null]}),e.jsxs("div",{className:"button-container flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6",children:[f&&e.jsx("div",{className:"filter-buttons flex gap-2",children:e.jsx("button",{className:o==="rating"?G:K,onClick:()=>b(l,"rating"),children:"Rating"})}),l==="legacy"&&e.jsxs("div",{className:"action-buttons flex gap-2",children:[v&&r&&(y?e.jsx("button",{className:`${I} bg-zinc-600 text-gray-400 border-gray-600 cursor-not-allowed opacity-70`,disabled:!0,children:"Claim Pending"}):e.jsx("button",{className:I,onClick:r,children:"Claim Profile"})),m&&e.jsx("button",{className:I,onClick:m,children:"Submit Result"})]})]})]}),e.jsxs("div",{className:"leaderboard-content",children:[e.jsx(ge,{data:L,type:l,filter:o,currentPage:g,onPageChange:_=>i(l,_),searchActive:!!p.trim(),onHistoryClick:M}),e.jsxs("div",{className:"record-cards",children:[T.map((_,a)=>e.jsxs("div",{className:"record-card",onClick:()=>M(_),role:"button",tabIndex:0,onKeyPress:k=>k.key==="Enter"&&M(_),children:[e.jsx("div",{className:"rank",children:C+a+1}),e.jsx("div",{className:"pic",children:e.jsx("div",{className:"profile-pic",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,className:"h-full w-full",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:`M5.121 17.804A9.969 9.969 0 \r
                         0112 15c2.387 0 4.58.834 6.364 \r
                         2.197M15 7a3 3 0 11-6 \r
                         0 3 3 0 016 0z`})})})}),e.jsxs("div",{className:"info",children:[e.jsx("div",{className:"name",children:_.name}),e.jsx("div",{className:"rating",children:Math.round(_.rating||0)})]})]},_.id||a)),e.jsxs("div",{className:"pagination-row",children:[C>0&&e.jsx("button",{className:"pagination-button",onClick:()=>i(l,g-1),children:"Previous 10"}),C+E<L.length&&e.jsx("button",{className:"pagination-button",onClick:()=>i(l,g+1),children:"Next 10"})]})]})]}),e.jsx(Y,{isOpen:c,onClose:F,title:`${(x==null?void 0:x.name)||"Bartender"}'s Competition History`,maxWidth:"max-w-4xl",children:x&&e.jsx(ue,{bartenderId:x.id,bartenderName:x.name})})]})}const $=ie("ClaimForm"),he=({onSuccess:s,onError:u})=>{const[l,h]=d.useState(null),[g,o]=d.useState(!1),[i,b]=d.useState(null),[f,v]=d.useState(!1),[y,t]=d.useState(null);d.useEffect(()=>{r()},[]);const r=async()=>{try{o(!0);const{data:{user:n}}=await S.auth.getUser();if(!n)return;const{data:c,error:w}=await S.from("submissions").select("id, status, content").eq("user_id",n.id).eq("status","pending").like("content",'%"type":"profile_claim"%').maybeSingle();if(w&&w.code!=="PGRST116")throw w;if(c){$.info("Found existing pending claim",{submissionId:c.id}),b(c);return}const{data:x,error:j}=await S.from("bartenders").select("id, is_profile_claimed").eq("user_id",n.id).single();if(j&&j.code!=="PGRST116")throw j;x!=null&&x.is_profile_claimed&&($.info("User already has a claimed profile",{bartenderId:x.id}),s==null||s({alreadyClaimed:!0}))}catch(n){$.error("Error checking existing claim:",n),t(n.message),u==null||u(n.message)}finally{o(!1)}},m=async n=>{n.preventDefault(),o(!0),t(null),v(!1);try{const{data:{user:c}}=await S.auth.getUser();if(!c)throw new Error("Authentication required");if(!l)throw new Error("Please select a bartender profile");const{data:w,error:x}=await S.from("bartenders").select("is_profile_claimed, users_attempting_to_claim").eq("id",l.id).single();if(x)throw x;if(w!=null&&w.is_profile_claimed)throw new Error("This profile has already been claimed");const j=w.users_attempting_to_claim||[];if(!j.includes(c.id)){const{error:E}=await S.from("bartenders").update({users_attempting_to_claim:[...j,c.id]}).eq("id",l.id);if(E)throw E}const{error:L}=await S.from("submissions").insert({user_id:c.id,content:JSON.stringify({type:"profile_claim",bartender_id:l.id,bartender_name:l.full_name,submitted_at:new Date().toISOString()}),status:"pending"});if(L)throw L;v(!0),$.info("Profile claim submitted successfully",{userId:c.id,bartenderId:l.id}),setTimeout(()=>{s==null||s()},2e3)}catch(c){t(c.message),u==null||u(c.message),$.error("Error submitting profile claim:",c)}finally{o(!1)}},p=async()=>{if(i){o(!0);try{const{data:{user:n}}=await S.auth.getUser();if(!n)throw new Error("Authentication required");let c=null;try{c=JSON.parse(i.content).bartender_id}catch(x){$.error("Error parsing claim content:",x)}if(c){const{data:x}=await S.from("bartenders").select("users_attempting_to_claim").eq("id",c).single();if(x){const j=(x.users_attempting_to_claim||[]).filter(L=>L!==n.id);await S.from("bartenders").update({users_attempting_to_claim:j}).eq("id",c)}}const{error:w}=await S.from("submissions").update({status:"cancelled"}).eq("id",i.id);if(w)throw w;b(null),s==null||s({cancelled:!0}),$.info("Claim cancelled successfully",{submissionId:i.id})}catch(n){t(n.message),u==null||u(n.message),$.error("Error cancelling claim:",n)}finally{o(!1)}}};return i?e.jsxs("div",{className:"p-6",children:[e.jsx("h3",{className:"text-xl text-white mb-4",children:"Pending Profile Claim"}),e.jsx("p",{className:"text-gray-300 mb-6",children:"Your profile claim is currently under review by an administrator."}),e.jsx("button",{onClick:p,disabled:g,className:"w-full py-2 bg-white text-black font-bold rounded hover:bg-zinc-200 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:g?"Processing...":"Cancel Claim"})]}):e.jsxs("form",{onSubmit:m,className:"p-6",method:"POST",children:[e.jsx("h3",{className:"text-xl text-white mb-6",children:"Claim Your Profile"}),y&&e.jsx("div",{className:"error-message mb-4 p-3 bg-red-500/20 border border-red-500 rounded text-red-200",children:y}),f&&e.jsx("div",{className:"success-message mb-4 p-3 bg-green-500/20 border border-green-500 rounded text-green-200",children:"Profile claim submitted successfully! Your claim will be reviewed by an administrator."}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-white mb-2",children:"Select Your Profile"}),e.jsx(ne,{onSelect:h,placeholder:"Search for your profile",unclaimedOnly:!0})]}),e.jsx("button",{type:"submit",disabled:g||!l||f,className:"w-full py-3 bg-white text-black font-bold rounded hover:bg-zinc-200 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:g?"Submitting...":"Submit Claim"})]})},H=J("UpcomingCompetitions"),Z=()=>{const[s,u]=d.useState([]),[l,h]=d.useState(!0),[g,o]=d.useState(null),{isAuthenticated:i}=X(),[b,f]=d.useState(!1);d.useEffect(()=>{const t=()=>{f(window.innerWidth<=768)};return t(),window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)},[]),d.useEffect(()=>{(async()=>{h(!0),o(null),H.info("Fetching upcoming competitions data...");try{const r=new Date().toISOString().split("T")[0],{data:m,error:p}=await A.from("legacy_competitions").select("id, name, date, venue, country, category, status, more_info_link").gte("date",r).order("date",{ascending:!0}).limit(3);if(p)throw H.error("Error fetching upcoming competitions:",p),new Error(`Failed to fetch upcoming competitions: ${p.message}`);u(m||[]),H.debug(`Fetched ${(m==null?void 0:m.length)||0} upcoming competitions.`)}catch(r){H.error("Error in fetchCompetitions:",r),o(r.message)}finally{h(!1)}})()},[]);const v=t=>{let r="category-badge",m=t||"Legacy";switch(t==null?void 0:t.toLowerCase()){case"speed":r+=" bg-red-500 text-white",m="Speed";break;case"flair":r+=" bg-green-500 text-black",m="Flair";break;case"traditional":r+=" bg-blue-500 text-white",m="Traditional";break;default:r+=" bg-zinc-500 text-white";break}return e.jsx("span",{className:`${r} inline-block px-2 py-1 rounded text-xs font-medium`,children:m})},y=t=>e.jsxs("div",{className:"bg-zinc-800 p-4 rounded-lg shadow-md h-full flex flex-col",children:[e.jsx("div",{className:"event-date text-sm text-gray-400 mb-1",children:new Date(t.date).toLocaleDateString()}),e.jsx("h3",{className:"event-name text-white font-medium text-lg mb-2",children:t.name}),e.jsx("div",{className:"event-category mb-2",children:v(t.category)}),e.jsx("div",{className:"event-venue text-gray-300 mb-4",children:t.venue}),e.jsx("div",{className:"mt-auto pt-4 border-t border-zinc-700",children:e.jsx("a",{href:"https://airtable.com/appMQggH3bB7G8pRV/pagGsPtPvflViR9PC/form",target:"_blank",rel:"noopener noreferrer",className:`block w-full py-2 text-center rounded ${i?"bg-white text-black hover:bg-zinc-200":"bg-zinc-600 text-gray-300 cursor-not-allowed"}`,onClick:r=>!i&&r.preventDefault(),title:i?"Register for event":"Sign in to register",children:i?"Register":"Sign in to Register"})})]});return s.length===0&&!l?null:l?e.jsxs("div",{className:"upcoming-competitions mt-8 mb-4",children:[e.jsx("h3",{className:"text-xl font-bold mb-4 text-white",children:"Upcoming Events"}),e.jsx("div",{className:"animate-pulse flex space-x-4",children:e.jsxs("div",{className:"flex-1 space-y-4 py-1",children:[e.jsx("div",{className:"h-12 bg-zinc-700 rounded"}),e.jsx("div",{className:"h-12 bg-zinc-700 rounded"})]})})]}):g?e.jsxs("div",{className:"upcoming-competitions mt-8 mb-4",children:[e.jsx("h3",{className:"text-xl font-bold mb-4 text-white",children:"Upcoming Events"}),e.jsx("div",{className:"bg-red-900/20 border border-red-500 text-red-200 p-4 rounded-lg",children:"Error loading upcoming events."})]}):e.jsxs("div",{className:"upcoming-competitions mt-8 mb-4",children:[e.jsx("h3",{className:"text-xl font-bold mb-4 text-white",children:"Upcoming Events"}),b&&e.jsx("div",{className:"md:hidden",children:e.jsx(le,{events:s,renderEventCard:y,emptyMessage:"No upcoming events scheduled yet."})}),!b&&e.jsx("div",{className:"hidden md:block bg-zinc-800 rounded-lg overflow-hidden",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-700",children:[e.jsx("thead",{className:"bg-zinc-700",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase",children:"Date"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase",children:"Event"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase",children:"Category"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase",children:"Location"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase",children:"Register"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-700",children:s.map(t=>e.jsxs("tr",{className:"hover:bg-zinc-750",children:[e.jsx("td",{className:"px-4 py-3 text-sm text-white",children:new Date(t.date).toLocaleDateString()}),e.jsx("td",{className:"px-4 py-3 text-sm text-white",children:t.name}),e.jsx("td",{className:"px-4 py-3 text-sm",children:v(t.category)}),e.jsx("td",{className:"px-4 py-3 text-sm text-white",children:t.venue}),e.jsx("td",{className:"px-4 py-3 text-sm",children:e.jsx("a",{href:"https://airtable.com/appMQggH3bB7G8pRV/pagGsPtPvflViR9PC/form",target:"_blank",rel:"noopener noreferrer",className:`px-3 py-1 rounded ${i?"bg-white text-black hover:bg-zinc-200":"bg-zinc-600 text-gray-300 cursor-not-allowed"}`,onClick:r=>!i&&r.preventDefault(),title:i?"Register for event":"Sign in to register",children:i?"Register":"Sign in to Register"})})]},t.id))})]})})]})},N=J("HomePage"),we=()=>{var _;const[s,u]=d.useState({legacy:[],traditional:[],flair:[],speed:[]}),[l,h]=d.useState(!0),[g,o]=d.useState(null),[i,b]=d.useState("Loading Leaderboards..."),[f,v]=d.useState(null),{user:y,isAuthenticated:t,profile:r,loading:m}=X(),[p,n]=d.useState(!1),[c,w]=d.useState({legacy:{page:0,filter:"rating"},speed:{page:0,filter:"rating"},traditional:{page:0,filter:"rating"},flair:{page:0,filter:"rating"}}),[x,j]=d.useState(!1),[L,E]=d.useState(!1),C=re(),T=ae(),M=(_=C.state)==null?void 0:_.scrollTo;d.useEffect(()=>{(async()=>{if(!t||!y){n(!1);return}try{const{data:k,error:P}=await A.from("submissions").select("id, status").eq("user_id",y.id).eq("status","pending").contains("content",{type:"profile_claim"}).maybeSingle();if(P)throw P;n(!!k),N.debug("Pending claim check result:",{hasPendingClaim:!!k})}catch(k){N.error("Error checking pending claims:",k)}})()},[t,y]);const F=d.useCallback(async()=>{h(!0),o(null),N.info("Fetching leaderboard data...");try{const a=await de.fetchLeaderboardData();u({legacy:(a==null?void 0:a.legacy)||[],traditional:(a==null?void 0:a.traditional)||[],flair:(a==null?void 0:a.flair)||[],speed:(a==null?void 0:a.speed)||[]}),N.info("Leaderboard data fetched successfully")}catch(a){N.error("Error fetching leaderboard data:",a),a.message.includes("timeout")?o("Loading took longer than expected. The system is experiencing delays. Please try refreshing the page or contact support if this persists."):a.message.includes("session")?o("Authentication issue detected. Please try signing out and back in."):a.message.includes("network")||a.message.includes("fetch")?o("Network connectivity issue. Please check your internet connection and try again."):o("Failed to load leaderboard data. Please try refreshing the page or contact support if this issue persists."),u({legacy:[],traditional:[],flair:[],speed:[]}),N.error("Fetch error context:",{errorType:a.name,errorMessage:a.message,stack:a.stack,timestamp:new Date().toISOString()})}finally{h(!1)}},[]);d.useEffect(()=>{if(m){N.debug("Waiting for auth state to be ready before fetching data");return}N.debug("Auth state ready, proceeding with data fetch",{isAuthenticated:t,authLoading:m}),F()},[F,m,t]),d.useEffect(()=>{if(!l)return;b("Loading Leaderboards..."),v(null);const a=setTimeout(()=>{l&&(b("Loading Leaderboards... this is taking a while, give it"),v(15))},1e4);return()=>clearTimeout(a)},[l]),d.useEffect(()=>{if(f===null||!l)return;if(f===0){T("/error",{state:{message:"Loading took too long (25+ seconds). This may indicate a connectivity issue.",contact:"cocktails+mbc@trapadl.com"}});return}const a=setTimeout(()=>{v(k=>k-1)},1e3);return()=>clearTimeout(a)},[f,T,l]),d.useEffect(()=>{if(M){N.debug(`Scrolling to section: ${M}`);const a=document.getElementById(`${M}-section`),k=document.querySelector(".column-right");if(a&&k){const P=a.offsetTop,B=parseFloat(getComputedStyle(k).paddingTop||"0"),R=P-B;N.debug(`Target offsetTop: ${P}, Container padding: ${B}, Effective scroll: ${R}`);const U=setTimeout(()=>{k.scrollTo({top:R,behavior:"smooth"}),T(C.pathname,{replace:!0,state:{...C.state,scrollTo:null}})},150);return()=>clearTimeout(U)}else N.warn(`Scroll target #${M}-section or .column-right not found`),T(C.pathname,{replace:!0,state:{...C.state,scrollTo:null}})}},[M,C.pathname,C.state,T]);const z=(a,k)=>{w(R=>({...R,[a]:{...R[a],page:k}}));const P=document.getElementById(`${a}-section`),B=document.querySelector(".column-right");if(P&&B){const R=P.offsetTop,U=parseFloat(getComputedStyle(B).paddingTop||"0"),ee=R-U;B.scrollTo({top:ee,behavior:"smooth"})}},D=(a,k)=>{w(P=>({...P,[a]:{...P[a],filter:k,page:0}}))},O=()=>{if(!t){W("Please sign in or create an account to claim a profile."),T("/enter",{state:{from:C}});return}j(!0),N.info("Claim Profile modal opened")},I=()=>{if(!t){W("Please sign in or create an account to submit results."),T("/enter",{state:{from:C}});return}E(!0),N.info("Submit Result modal opened")},G=!(t&&(r==null?void 0:r.is_profile_claimed)===!0)&&!p;return l||m?e.jsxs("div",{className:"flex flex-col justify-center items-center h-screen col-span-2",children:[e.jsxs("div",{className:"flex items-center mb-4",children:[e.jsx("div",{className:"animate-spin h-8 w-8 border-4 border-white rounded-full border-t-transparent"}),e.jsx("span",{className:"ml-4 text-gray-300",children:i})]}),f!==null&&e.jsxs("div",{className:"text-center",children:[e.jsxs("span",{className:"text-yellow-400 font-bold text-lg",children:["[",f,"]"]}),e.jsx("span",{className:"text-gray-300 ml-2",children:"more seconds before calling it an issue"})]})]}):g?e.jsx("div",{className:"text-center p-10 text-red-400 col-span-2",children:g}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"column-left hidden md:flex",children:[" ",e.jsxs("div",{className:"column-left-content text-white p-8",children:[" ",e.jsx("div",{style:{height:"calc(100vh * 4 / 13)",minHeight:"200px",flexShrink:0}}),t&&r?e.jsxs("h2",{className:"text-2xl font-bold mb-4",children:["Welcome, ",r.full_name||"Competitor","!"]}):e.jsx("h2",{className:"text-2xl font-bold mb-4",children:"PROFESSIONAL BARTENDING. A NEW GLOBAL SPORT."}),e.jsx("p",{className:"mb-4 text-gray-300",children:"Our goal is to transform one of the worlds oldest professions into a thrilling, worldwide competition by uniting bartenders, bars, and brands under one transparent ranking system."}),e.jsx("p",{className:"mb-4 text-gray-300",children:"These leaderboards rank bartenders with registered competition results. Legacy competitions are events held by brand organisers - the ones most bartenders are familiar with. MBC Speed, Traditional and Flair and MBC sanctioned events that adhere to guidelines of fairness, transparency and integrity."}),e.jsx("p",{className:"mb-4 text-gray-300",children:"To add yourself to the leaderboard, click 'submit result'."}),e.jsx("p",{className:"mb-4 text-gray-300",children:"To find out more about our pillars and goals, click the about section of our site menu."}),e.jsx(Z,{}),e.jsxs("p",{className:"text-gray-400 text-sm mt-8",children:["This service is created and maintained by passionate bartenders out of ",e.jsx("a",{href:"http://www.trapadl.com",className:"text-white hover:text-gray-300",target:"_blank",rel:"noopener noreferrer",children:"trap. cocktail bar"})," in Adelaide, Australia. It's constantly undergoing improvements. Feedback, bug reports, or contribution inquiries are welcome via ",e.jsx("a",{href:"mailto:cocktails+mbc@trapadl.com",className:"text-white hover:text-gray-300",children:"cocktails+mbc@trapadl.com"}),"."]})]})]}),e.jsxs("div",{className:"block md:hidden p-4 text-white",children:[e.jsx("div",{style:{minHeight:"200px",flexShrink:0}}),t&&r?e.jsxs("h2",{className:"text-2xl font-bold mb-4",children:["Welcome, ",r.full_name||"Competitor","!"]}):e.jsx("h2",{className:"text-2xl font-bold mb-4",children:"PROFESSIONAL BARTENDING. A NEW GLOBAL SPORT."}),e.jsx("p",{className:"mb-4 text-gray-300",children:"Our goal is to transform one of the worlds oldest professions into a thrilling, worldwide competition by uniting bartenders, bars, and brands under one transparent ranking system."}),e.jsx("p",{className:"mb-4 text-gray-300",children:"These leaderboards rank bartenders with registered competition results. Legacy competitions are events held by brand organisers - the ones most bartenders are familiar with. MBC Speed, Traditional and Flair and MBC sanctioned events that adhere to guidelines of fairness, transparency and integrity."}),e.jsx("p",{className:"mb-4 text-gray-300",children:"To add yourself to the leaderboard, click 'submit result'."}),e.jsx("p",{className:"mb-4 text-gray-300",children:"To find out more about our pillars and goals, click the about section of our site menu."}),e.jsx(Z,{}),e.jsxs("p",{className:"text-gray-400 text-sm mt-8",children:["This service is created and maintained by passionate bartenders out of ",e.jsx("a",{href:"http://www.trapadl.com",className:"text-white hover:text-gray-300",target:"_blank",rel:"noopener noreferrer",children:"trap. cocktail bar"})," in Adelaide, Australia. It's constantly undergoing improvements. Feedback, bug reports, or contribution inquiries are welcome via ",e.jsx("a",{href:"mailto:cocktails+mbc@trapadl.com",className:"text-white hover:text-gray-300",children:"cocktails+mbc@trapadl.com"}),"."]})]}),e.jsxs("div",{className:"column-right w-full md:w-1/2",children:[" ",e.jsxs("div",{className:"column-right-content space-y-12 p-4 md:p-8 ",children:[" ",e.jsx(q,{id:"legacy-section",title:"Legacy Leaderboard",type:"legacy",data:s.legacy,page:c.legacy.page,filter:c.legacy.filter,onPageChange:z,onFilterChange:D,showFilters:!1,showClaimButton:G,hasPendingClaim:p,onClaimProfileClick:O,onSubmitResultClick:I}),e.jsx(q,{id:"speed-section",title:"MBC Speed Leaderboard",type:"speed",data:s.speed,page:c.speed.page,filter:c.speed.filter,onPageChange:z,onFilterChange:D}),e.jsx(q,{id:"traditional-section",title:"MBC Traditional Leaderboard",type:"traditional",data:s.traditional,page:c.traditional.page,filter:c.traditional.filter,onPageChange:z,onFilterChange:D,comingSoon:!0}),e.jsx(q,{id:"flair-section",title:"MBC Flair Leaderboard",type:"flair",data:s.flair,page:c.flair.page,filter:c.flair.filter,onPageChange:z,onFilterChange:D,comingSoon:!0})]})]}),e.jsx(Y,{isOpen:x,onClose:()=>j(!1),title:"Claim Your Profile",children:e.jsx(he,{onSuccess:()=>{N.info("Claim success callback triggered."),j(!1),n(!0),F()},onError:a=>N.error("Claim form error:",a)})}),e.jsx(Y,{isOpen:L,onClose:()=>E(!1),title:"Submit Competition Result",maxWidth:"max-w-2xl",children:e.jsx(oe,{onSuccess:()=>{N.info("Result success callback triggered."),E(!1),W("Result submitted for admin review!")},onError:a=>N.error("Result form error:",a)})}),e.jsx("div",{className:"fixed bottom-4 left-1/2 transform -translate-x-1/2 md:hidden z-50",children:e.jsx("button",{onClick:()=>{const a=document.querySelector(".column-right");a&&a.scrollIntoView({behavior:"smooth"})},className:"bg-black text-white px-6 py-3 rounded-full shadow-lg hover:bg-zinc-800 transition",children:"↓ Leaderboards ↓"})})]})};export{we as default};
