import{r as n,s as F,j as e,c as Y,R as K}from"./main-D1s2dzev.js";import{s as _,c as M,d as Q,e as X,a as ne,O as le}from"./toast-BIDwJeh5.js";const ce=Y("AdminTabsNav"),de=({activeTab:t,onTabChange:g})=>{n.useEffect(()=>{p()},[]);const p=async()=>{try{const{data:{user:o}}=await F.auth.getUser();if(!o){window.location.href="/";return}const{data:c,error:f}=await F.from("bartenders").select("is_admin").eq("user_id",o.id).single();(f||!(c!=null&&c.is_admin))&&(window.location.href="/")}catch(o){ce.error("Error verifying admin access:",o),window.location.href="/"}},l=[{id:"results",label:"Competition Results",description:"Review and manage competition results"},{id:"bartenders",label:"Bartenders",description:"Manage bartender profiles and rankings"},{id:"organisers",label:"Organisers",description:"Manage competition organisers"},{id:"profile_claims",label:"Profile Claims",description:"Review and manage profile claims"},{id:"glicko_ratings",label:"Glicko Ratings"}];return e.jsx("nav",{className:"flex space-x-1 mb-6 bg-zinc-800 p-1 rounded-lg overflow-x-auto",role:"tablist","aria-label":"Admin sections",children:l.map(o=>e.jsx("button",{onClick:()=>g(o.id),className:`
            px-4 py-2 rounded-md transition-colors whitespace-nowrap
            ${t===o.id?"bg-black text-white":"text-gray-300 hover:bg-zinc-700"}
          `,role:"tab","aria-selected":t===o.id,"aria-controls":`${o.id}-panel`,id:`${o.id}-tab`,title:o.description,children:o.label},o.id))})},L=Y("AdminActions"),oe=({id:t,isEditing:g,onEdit:p,onSave:l,onCancel:o,onApprove:c,onDeny:f,showApproveButtons:v,disabled:h=!1})=>{const N=()=>{L.debug("Edit action triggered",{id:t}),p==null||p()},d=()=>{L.debug("Save action triggered",{id:t}),l==null||l()},a=()=>{L.debug("Cancel action triggered",{id:t}),o==null||o()},r=()=>{L.info("Approve action triggered",{id:t}),c==null||c()},m=()=>{L.info("Deny action triggered",{id:t}),f==null||f()};return e.jsx("div",{className:"flex gap-2 items-center",children:g?e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:d,disabled:h,className:"bg-green-600 hover:bg-green-700 px-3 py-1 rounded text-white transition-colors disabled:opacity-50 disabled:cursor-not-allowed","aria-label":"Save changes",children:"Save"}),e.jsx("button",{onClick:a,disabled:h,className:"bg-zinc-600 hover:bg-zinc-700 px-3 py-1 rounded text-white transition-colors disabled:opacity-50 disabled:cursor-not-allowed","aria-label":"Cancel editing",children:"Cancel"})]}):e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:N,disabled:h,className:"bg-black hover:bg-blue-700 px-3 py-1 rounded text-white transition-colors disabled:opacity-50 disabled:cursor-not-allowed","aria-label":"Edit item",children:"Edit"}),v&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:r,disabled:h,className:"bg-green-600 hover:bg-green-700 px-3 py-1 rounded text-white transition-colors disabled:opacity-50 disabled:cursor-not-allowed","aria-label":"Approve item",children:"Approve"}),e.jsx("button",{onClick:m,disabled:h,className:"bg-red-600 hover:bg-red-700 px-3 py-1 rounded text-white transition-colors disabled:opacity-50 disabled:cursor-not-allowed","aria-label":"Deny item",children:"Deny"})]})]})})},W=M("BartendersTab"),ue=()=>{const[t,g]=n.useState([]),[p,l]=n.useState(!0),[o,c]=n.useState(null),[f,v]=n.useState(null),[h,N]=n.useState({}),[d,a]=n.useState(""),[r,m]=n.useState(1),[u,x]=n.useState(10),[b,s]=n.useState("created_at"),[w,k]=n.useState("desc"),[S,A]=n.useState("all");n.useEffect(()=>{$()},[b,w,S,r,u]);const $=async()=>{try{l(!0);let i=_.from("bartenders").select(`
          id,
          full_name,
          bar,
          user_id,
          is_admin,
          is_approved,
          is_profile_claimed,
          is_archived,
          created_at,
          updated_at
        `);S==="approved"?i=i.eq("is_approved",!0):S==="unapproved"?i=i.eq("is_approved",!1):S==="archived"?i=i.eq("is_archived",!0):S==="active"&&(i=i.eq("is_archived",!1)),d&&(i=i.ilike("full_name",`%${d}%`)),i=i.order(b,{ascending:w==="asc"});const D=(r-1)*u,z=D+u-1;i=i.range(D,z);const{data:I,error:R,count:ze}=await i;if(R)throw R;g(I||[]);const{count:ie}=await _.from("bartenders").select("id",{count:"exact",head:!0});H(Math.ceil(ie/u))}catch(i){W.error("Error fetching bartenders:",i),c(i.message)}finally{l(!1)}},[O,H]=n.useState(1),G=i=>{v(i.id),N({...i})},V=async()=>{try{l(!0);const{error:i}=await _.from("bartenders").update(h).eq("id",f);if(i)throw i;Q("Bartender updated successfully"),await $(),v(null),N({})}catch(i){W.error("Error saving bartender:",i),c(i.message),X(`Error: ${i.message}`)}finally{l(!1)}},j=()=>{v(null),N({})},y=(i,D)=>{N(z=>({...z,[i]:D}))},C=async(i,D)=>{try{l(!0);let z={},I="";switch(D){case"approve":z={is_approved:!0},I="Bartender approved successfully";break;case"reject":z={is_approved:!1},I="Bartender rejected successfully";break;case"archive":z={is_archived:!0},I="Bartender archived successfully";break;case"unarchive":z={is_archived:!1},I="Bartender restored successfully";break;default:throw new Error("Invalid action")}const{error:R}=await _.from("bartenders").update(z).eq("id",i);if(R)throw R;Q(I),await $()}catch(z){W.error(`Error performing ${D} action:`,z),c(z.message),X(`Error: ${z.message}`)}finally{l(!1)}},E=i=>{b===i?k(w==="asc"?"desc":"asc"):(s(i),k("asc"))},q=i=>b!==i?"↕":w==="asc"?"↑":"↓",P=(i,D,z="text")=>f===i.id?z==="checkbox"?e.jsx("input",{type:"checkbox",checked:h[D]||!1,onChange:R=>y(D,R.target.checked),className:"form-checkbox h-5 w-5 text-blue-600"}):e.jsx("input",{type:z,value:h[D]||"",onChange:R=>y(D,R.target.value),className:"w-full bg-zinc-700 text-white px-2 py-1 rounded"}):z==="checkbox"?e.jsx("span",{className:i[D]?"text-green-400":"text-red-400",children:i[D]?"Yes":"No"}):i[D]||e.jsx("span",{className:"text-gray-500",children:"—"});return p&&t.length===0?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin h-8 w-8 border-4 border-blue-500 rounded-full border-t-transparent"})}):e.jsxs("div",{children:[e.jsx("div",{className:"mb-6 bg-zinc-800 p-4 rounded-lg",children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-4 mb-4",children:[e.jsx("div",{className:"flex-1",children:e.jsx("input",{type:"text",placeholder:"Search by name...",value:d,onChange:i=>a(i.target.value),className:"w-full p-2 bg-zinc-700 text-white rounded border border-gray-600"})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>{a(""),$()},className:"px-4 py-2 bg-black text-white rounded",children:"Search"}),e.jsxs("select",{value:S,onChange:i=>A(i.target.value),className:"p-2 bg-zinc-700 text-white rounded border border-gray-600",children:[e.jsx("option",{value:"all",children:"All Bartenders"}),e.jsx("option",{value:"approved",children:"Approved"}),e.jsx("option",{value:"unapproved",children:"Unapproved"}),e.jsx("option",{value:"active",children:"Active (Not Archived)"}),e.jsx("option",{value:"archived",children:"Archived"})]})]})]})}),o&&e.jsx("div",{className:"bg-red-900/50 border border-red-500 text-red-200 p-4 rounded-lg mb-6",children:o}),e.jsx("div",{className:"bg-zinc-800 rounded-lg overflow-hidden",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-700",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left",children:e.jsxs("button",{className:"text-xs font-medium text-gray-400 uppercase flex items-center",onClick:()=>E("full_name"),children:["Name ",q("full_name")]})}),e.jsx("th",{className:"px-4 py-3 text-left",children:e.jsxs("button",{className:"text-xs font-medium text-gray-400 uppercase flex items-center",onClick:()=>E("bar"),children:["Bar ",q("bar")]})}),e.jsx("th",{className:"px-4 py-3 text-left",children:e.jsxs("button",{className:"text-xs font-medium text-gray-400 uppercase flex items-center",onClick:()=>E("is_approved"),children:["Approved ",q("is_approved")]})}),e.jsx("th",{className:"px-4 py-3 text-left",children:e.jsxs("button",{className:"text-xs font-medium text-gray-400 uppercase flex items-center",onClick:()=>E("is_profile_claimed"),children:["Claimed ",q("is_profile_claimed")]})}),e.jsx("th",{className:"px-4 py-3 text-left",children:e.jsxs("button",{className:"text-xs font-medium text-gray-400 uppercase flex items-center",onClick:()=>E("is_admin"),children:["Admin ",q("is_admin")]})}),e.jsx("th",{className:"px-4 py-3 text-left",children:e.jsxs("button",{className:"text-xs font-medium text-gray-400 uppercase flex items-center",onClick:()=>E("is_archived"),children:["Archived ",q("is_archived")]})}),e.jsx("th",{className:"px-4 py-3 text-left",children:e.jsxs("button",{className:"text-xs font-medium text-gray-400 uppercase flex items-center",onClick:()=>E("created_at"),children:["Created ",q("created_at")]})}),e.jsx("th",{className:"px-4 py-3"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-700",children:t.map(i=>e.jsxs("tr",{className:i.is_archived?"opacity-50":"",children:[e.jsx("td",{className:"px-4 py-3 text-sm text-white",children:P(i,"full_name")}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-300",children:P(i,"bar")}),e.jsx("td",{className:"px-4 py-3 text-sm",children:P(i,"is_approved","checkbox")}),e.jsx("td",{className:"px-4 py-3 text-sm",children:P(i,"is_profile_claimed","checkbox")}),e.jsx("td",{className:"px-4 py-3 text-sm",children:P(i,"is_admin","checkbox")}),e.jsx("td",{className:"px-4 py-3 text-sm",children:P(i,"is_archived","checkbox")}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-400",children:new Date(i.created_at).toLocaleDateString()}),e.jsx("td",{className:"px-4 py-3 text-sm whitespace-nowrap",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(oe,{id:i.id,isEditing:f===i.id,onEdit:()=>G(i),onSave:V,onCancel:j,disabled:p}),f!==i.id&&e.jsxs("div",{className:"flex gap-2 ml-2",children:[!i.is_approved&&e.jsx("button",{onClick:()=>C(i.id,"approve"),className:"bg-green-600 hover:bg-green-700 px-3 py-1 rounded text-white transition-colors",title:"Approve",children:"✓"}),i.is_approved&&e.jsx("button",{onClick:()=>C(i.id,"reject"),className:"bg-red-600 hover:bg-red-700 px-3 py-1 rounded text-white transition-colors",title:"Reject",children:"✕"}),i.is_archived?e.jsx("button",{onClick:()=>C(i.id,"unarchive"),className:"bg-black hover:bg-white px-3 py-1 rounded text-white transition-colors",title:"Restore",children:"🔄"}):e.jsx("button",{onClick:()=>C(i.id,"archive"),className:"bg-yellow-600 hover:bg-yellow-700 px-3 py-1 rounded text-white transition-colors",title:"Archive",children:"📦"})]})]})})]},i.id))})]})})}),e.jsxs("div",{className:"mt-4 flex justify-between items-center",children:[e.jsx("div",{children:e.jsxs("select",{value:u,onChange:i=>{x(Number(i.target.value)),m(1)},className:"bg-zinc-700 text-white rounded p-2 border border-gray-600",children:[e.jsx("option",{value:10,children:"10 per page"}),e.jsx("option",{value:25,children:"25 per page"}),e.jsx("option",{value:50,children:"50 per page"}),e.jsx("option",{value:100,children:"100 per page"})]})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>m(i=>Math.max(i-1,1)),disabled:r===1,className:"px-3 py-1 bg-zinc-700 text-white rounded disabled:opacity-50",children:"Previous"}),e.jsxs("span",{className:"px-3 py-1 bg-zinc-700 text-white rounded",children:["Page ",r," of ",O]}),e.jsx("button",{onClick:()=>m(i=>Math.min(i+1,O)),disabled:r===O,className:"px-3 py-1 bg-zinc-700 text-white rounded disabled:opacity-50",children:"Next"})]})]})]})},xe=({competition:t,onSave:g,onCancel:p})=>{const[l,o]=n.useState({name:t.name||"",date:t.date||"",venue:t.venue||"",country:t.country||""}),[c,f]=n.useState(!1),[v,h]=n.useState(!1),[N,d]=n.useState(null);n.useEffect(()=>{o({name:t.name||"",date:t.date||"",venue:t.venue||"",country:t.country||""}),f(!1),d(null)},[t]);const a=(u,x)=>{o(b=>({...b,[u]:x})),f(!0),d(null)},r=()=>{var x,b;if(!((x=l.name)!=null&&x.trim()))throw new Error("Competition name is required");if(!l.date)throw new Error("Competition date is required");if(!((b=l.venue)!=null&&b.trim()))throw new Error("Venue is required");const u=new Date(l.date);if(isNaN(u.getTime()))throw new Error("Invalid date format")},m=async()=>{if(!c){p();return}h(!0),d(null);try{r(),await g({...l,name:l.name.trim(),venue:l.venue.trim(),country:l.country||null,date:new Date(l.date).toISOString().split("T")[0]})}catch(u){d(u.message),h(!1);return}h(!1)};return e.jsxs("div",{className:"bg-zinc-700 rounded p-6",children:[N&&e.jsx("div",{className:"mb-4 p-3 bg-red-500/20 border border-red-500 text-red-200 rounded",children:N}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-white mb-2",children:["Competition Name ",e.jsx("span",{className:"text-red-400",children:"*"})]}),e.jsx("input",{type:"text",value:l.name,onChange:u=>a("name",u.target.value),className:"w-full p-2 bg-zinc-600 text-white rounded border border-gray-500 focus:border-blue-500 focus:outline-none",placeholder:"Enter competition name",required:!0})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-white mb-2",children:["Date ",e.jsx("span",{className:"text-red-400",children:"*"})]}),e.jsx("input",{type:"date",value:l.date,onChange:u=>a("date",u.target.value),className:"w-full p-2 bg-zinc-600 text-white rounded border border-gray-500 focus:border-blue-500 focus:outline-none",required:!0})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-white mb-2",children:["Venue ",e.jsx("span",{className:"text-red-400",children:"*"})]}),e.jsx("input",{type:"text",value:l.venue,onChange:u=>a("venue",u.target.value),className:"w-full p-2 bg-zinc-600 text-white rounded border border-gray-500 focus:border-blue-500 focus:outline-none",placeholder:"Enter venue name",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-white mb-2",children:"Country"}),e.jsxs("select",{value:l.country||"",onChange:u=>a("country",u.target.value),className:"w-full p-2 bg-zinc-600 text-white rounded border border-gray-500 focus:border-blue-500 focus:outline-none",children:[e.jsx("option",{value:"",children:"Select a country"}),ne.map(u=>e.jsx("option",{value:u,children:u},u))]})]})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx("button",{onClick:p,disabled:v,className:"px-4 py-2 bg-zinc-600 text-white rounded hover:bg-zinc-500 disabled:opacity-50 disabled:cursor-not-allowed",children:"Cancel"}),e.jsx("button",{onClick:m,disabled:v||!c&&!N,className:"px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed",children:v?"Saving...":"Save Changes"})]})]})},Z=M("ResultsTable"),me=t=>{if(!t)return"";t=t.replace(/^(https?:\/\/)/,""),t.startsWith("www.")&&(t=t.substring(4));const g=t.split("/").filter(Boolean),p=g[0],l=g[g.length-1]||"";return`${p}/../${l}`},he=({results:t=[],competitionStatus:g,onResultStatusChange:p})=>{Z.debug("Rendering results table",{resultCount:t==null?void 0:t.length,competitionStatus:g});const l=g==="approved";if(Z.debug("ResultsTable actions visibility",{competitionStatus:g,showActions:l}),!(t!=null&&t.length))return e.jsx("div",{className:"bg-zinc-700 p-4 rounded text-gray-400 text-center",children:"No results available"});const o=[...t].sort((c,f)=>c.placement-f.placement);return e.jsx("div",{className:"bg-zinc-700 rounded overflow-hidden",children:e.jsxs("table",{className:"w-full text-left",children:[e.jsx("thead",{className:"bg-zinc-600",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-3 text-white",children:"Position"}),e.jsx("th",{className:"p-3 text-white",children:"Bartender"}),e.jsx("th",{className:"p-3 text-white",children:"Source"}),e.jsx("th",{className:"p-3 text-white",children:"Status"}),l&&e.jsx("th",{className:"p-3 text-white",children:"Actions"})]})}),e.jsx("tbody",{children:o.map(c=>{var f;return e.jsxs("tr",{className:"border-t border-gray-600",children:[e.jsx("td",{className:"p-3 text-white",children:c.placement}),e.jsx("td",{className:"p-3 text-white",children:((f=c.bartenders)==null?void 0:f.full_name)||"Unknown Bartender"}),e.jsx("td",{className:"p-3 text-white",children:c.result_source?e.jsx("a",{href:c.result_source,target:"_blank",rel:"noopener noreferrer",className:"text-blue-400 hover:text-blue-300",children:me(c.result_source)}):"No source"}),e.jsx("td",{className:`p-3 ${c.status==="pending"?"text-yellow-400":c.status==="approved"?"text-green-400":c.status==="rejected"?"text-red-400":c.status==="deprecated"?"text-gray-400":"text-white"}`,children:c.status||"pending"}),l&&e.jsx("td",{className:"p-3",children:c.status==="pending"&&e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>p==null?void 0:p(c.id,"approved"),className:"bg-green-600 hover:bg-green-700 px-3 py-1 rounded text-white",children:"Approve"}),e.jsx("button",{onClick:()=>p==null?void 0:p(c.id,"rejected"),className:"bg-red-600 hover:bg-red-700 px-3 py-1 rounded text-white",children:"Reject"})]})})]},c.id)})})]})})},ge=({sourceCompetition:t,targetCompetitions:g,onClose:p,onMerge:l})=>{var a;const[o,c]=n.useState(null),[f,v]=n.useState({name:!1,date:!1,venue:!1,country:!1,organizer:!1,results:!0}),[h,N]=n.useState("");n.useEffect(()=>{c(null),v({name:!1,date:!1,venue:!1,country:!1,organizer:!1,results:!0}),N("")},[t==null?void 0:t.id]);const d=async()=>{if(!o)return;const r=g.find(m=>m.id===o);await l({sourceId:t.id,targetId:o,fields:f,notes:h,sourceCompetition:t,targetCompetition:r}),p()};return e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-zinc-800 rounded-lg p-6 max-w-4xl w-full m-4 max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h2",{className:"text-xl font-bold text-white",children:"Select Competition to Merge Into"}),e.jsx("button",{onClick:p,className:"text-gray-400 hover:text-white",children:"×"})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg text-white mb-2",children:"Source Competition"}),e.jsxs("div",{className:"bg-zinc-700 p-4 rounded",children:[e.jsx("div",{className:"text-white",children:t.name}),e.jsxs("div",{className:"text-gray-400",children:[new Date(t.date).toLocaleDateString()," at ",t.venue]}),((a=t.legacy_results)==null?void 0:a.length)>0&&e.jsxs("div",{className:"mt-2 text-gray-400",children:["Results: ",t.legacy_results.length," competitor(s)"]})]})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg text-white mb-2",children:"Similar Competitions"}),e.jsx("div",{className:"space-y-2",children:g==null?void 0:g.map(r=>e.jsxs("div",{onClick:()=>c(r.id),className:`p-4 rounded cursor-pointer transition-colors ${o===r.id?"bg-black":"bg-zinc-700 hover:bg-zinc-600"}`,children:[e.jsx("div",{className:"text-white",children:r.name}),e.jsxs("div",{className:"text-gray-400",children:[new Date(r.date).toLocaleDateString()," at ",r.venue]})]},r.id))})]}),o&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg text-white mb-4",children:"Fields to Merge"}),e.jsx("div",{className:"space-y-4",children:Object.entries({name:"Competition Name",date:"Date",venue:"Venue",country:"Country",organizer:"Organizer",results:"Results"}).map(([r,m])=>{var u;return e.jsxs("div",{className:"flex justify-between items-center bg-zinc-700 p-4 rounded",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-white font-medium mb-1",children:m}),r!=="results"&&e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"text-gray-400",children:["Source: ",t[r]||"Not set"]}),e.jsxs("div",{className:"text-gray-400",children:["Target: ",((u=g.find(x=>x.id===o))==null?void 0:u[r])||"Not set"]})]})]}),e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",checked:f[r],onChange:x=>v(b=>({...b,[r]:x.target.checked})),className:"mr-2",disabled:r==="results"}),e.jsx("span",{className:"text-white",children:"Use source value"})]})]},r)})})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-white mb-2",children:"Merge Notes"}),e.jsx("textarea",{value:h,onChange:r=>N(r.target.value),className:"w-full p-2 bg-zinc-700 text-white rounded border border-gray-600",rows:3,placeholder:"Add notes about why these competitions are being merged..."})]}),e.jsxs("div",{className:"flex justify-end gap-4",children:[e.jsx("button",{onClick:p,className:"px-4 py-2 bg-zinc-600 text-white rounded hover:bg-zinc-700",children:"Cancel"}),e.jsx("button",{onClick:d,disabled:!o,className:"px-4 py-2 bg-black text-white rounded hover:bg-white disabled:opacity-50",children:"Merge Competitions"})]})]})})},ee=M("ResultsConflictResolution"),pe=({competitionId:t,results:g=[],onResolve:p})=>{const[l,o]=n.useState([]),[c,f]=n.useState(!1),[v,h]=n.useState(null);n.useEffect(()=>{t&&N()},[t]);const N=async()=>{try{const{data:a,error:r}=await _.from("legacy_results").select(`
          id,
          bartender_id,
          placement,
          points,
          status,
          pre_competition_rating,
          post_competition_rating,
          bartenders (
            id,
            full_name,
            rating
          )
        `).eq("legacy_competition_id",t).eq("status","pending_review");if(r)throw r;if(!(a!=null&&a.length)){o([]);return}const m=a.map(s=>s.bartender_id),{data:u,error:x}=await _.from("legacy_results").select(`
          id,
          bartender_id,
          placement,
          points,
          status,
          legacy_competition_id,
          legacy_competitions (
            id,
            name,
            date
          ),
          bartenders (
            id,
            full_name
          )
        `).in("bartender_id",m).neq("legacy_competition_id",t).eq("status","approved");if(x)throw x;const b=a.map(s=>({...s,otherResults:(u==null?void 0:u.filter(w=>w.bartender_id===s.bartender_id))||[]}));o(b)}catch(a){ee.error("Error fetching conflicts:",a),h(a.message)}},d=async(a,r)=>{f(!0);try{const m=l.find(x=>x.id===a);if(!m)return;const{error:u}=await _.from("legacy_results").update({status:r==="approve"?"approved":"rejected",updated_at:new Date().toISOString()}).eq("id",a);if(u)throw u;if(r==="approve"){const x=m.otherResults.map(b=>_.from("legacy_results").update({status:"deprecated",updated_at:new Date().toISOString()}).eq("id",b.id));await Promise.all(x)}await N(),p==null||p()}catch(m){ee.error("Error resolving conflict:",m),h(m.message)}finally{f(!1)}};return l.length?e.jsxs("div",{className:"mt-8 bg-zinc-800 p-6 rounded-lg",children:[e.jsx("h3",{className:"text-xl text-white mb-4",children:"Resolve Results"}),v&&e.jsx("div",{className:"bg-red-500/20 border border-red-500 text-red-200 p-4 rounded mb-4",children:v}),e.jsx("div",{className:"space-y-4",children:l.map(a=>{var r;return e.jsx("div",{className:"bg-zinc-700 p-4 rounded",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"text-white font-medium",children:((r=a.bartenders)==null?void 0:r.full_name)||"Unknown Bartender"}),e.jsxs("div",{className:"mt-2 text-gray-400",children:[e.jsxs("div",{children:["Placement: ",a.placement]}),e.jsxs("div",{children:["Points: ",a.points]}),a.otherResults.length>0&&e.jsxs("div",{className:"mt-2",children:[e.jsx("div",{className:"text-yellow-400",children:"Existing Results:"}),a.otherResults.map(m=>{var u,x;return e.jsxs("div",{className:"ml-4 mt-1",children:[e.jsx("div",{children:(u=m.legacy_competitions)==null?void 0:u.name}),e.jsxs("div",{children:["Date: ",new Date((x=m.legacy_competitions)==null?void 0:x.date).toLocaleDateString()]}),e.jsxs("div",{children:["Placement: ",m.placement]}),e.jsxs("div",{children:["Points: ",m.points]})]},m.id)})]})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>d(a.id,"approve"),disabled:c,className:"px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 disabled:opacity-50",children:"Approve"}),e.jsx("button",{onClick:()=>d(a.id,"reject"),disabled:c,className:"px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 disabled:opacity-50",children:"Reject"})]})]})},a.id)})})]}):null},T=M("useCompetitionMerge"),fe=(t,g)=>{const[p,l]=n.useState(null),[o,c]=n.useState([]),[f,v]=n.useState({isOpen:!1,sourceCompetition:null,targetCompetition:null});return{selectedId:p,setSelectedId:l,similarCompetitions:o,mergeModalState:f,setMergeModalState:v,handleMergeClick:async(d,a=null)=>{var r;T.debug("Handling merge click",{sourceId:d,targetId:a});try{const{data:m,error:u}=await _.from("legacy_competitions").select(`
          *,
          legacy_results (
            id,
            bartender_id,
            placement,
            points,
            status,
            bartenders (
              id,
              full_name
            )
          )
        `).eq("id",d).single();if(u)throw u;T.debug("Fetched source competition",{id:m.id,resultsCount:(r=m.legacy_results)==null?void 0:r.length});const{data:x,error:b}=await _.from("legacy_competitions").select(`
          *,
          legacy_results (
            id,
            bartender_id,
            placement,
            points,
            status,
            bartenders (
              id,
              full_name
            )
          )
        `).neq("id",d).not("status","in",'("merged")').ilike("name",`%${m.name.split(" ").join("%")}%`);if(b)throw b;if(c(x||[]),a){const s=x==null?void 0:x.find(w=>w.id===a);s&&v({isOpen:!0,sourceCompetition:m,targetCompetition:s})}else(x==null?void 0:x.length)>0&&v({isOpen:!0,sourceCompetition:m,targetCompetition:null})}catch(m){throw T.error("Error preparing merge:",m),m}},handleMergeComplete:async d=>{T.debug("Starting merge with details:",{sourceId:d.sourceId,targetId:d.targetId});try{const{data:{user:a}}=await _.auth.getUser();if(!a)throw new Error("Authentication required");const{error:r}=await _.from("legacy_competitions").update({status:"merged",merged_into_id:d.targetId,merge_notes:d.notes,updated_by:a.id,updated_at:new Date().toISOString()}).eq("id",d.sourceId);if(r)throw r;T.info("Merge completed successfully"),await g(),l(null),v({isOpen:!1,sourceCompetition:null,targetCompetition:null})}catch(a){throw T.error("Error completing merge:",a),a}}}},B=M("Competition"),be=({competition:t,onUpdate:g,onResultStatusChange:p})=>{const[l,o]=n.useState(!1),[c,f]=n.useState(!1),[v,h]=n.useState(null),[N,d]=n.useState(!1),[a,r]=n.useState([]);B.debug("Competition component rendering",{competitionId:t.id,competitionStatus:t.status,competitionName:t.name}),fe(t,g);const m=async()=>{f(!0),h(null);try{B.debug("Checking similar competitions",{competitionId:t.id});const{data:b,error:s}=await _.from("legacy_competitions").select(`
          id, 
          name,
          date,
          venue,
          country,
          status,
          category,
          legacy_results (
            id,
            bartender_id,
            placement,
            points,
            status,
            result_source,
            competition_category
          )
        `).neq("id",t.id).not("status","in",'("merged")').ilike("name",`%${t.name.split(" ").join("%")}%`);if(s)throw s;r(b||[]),d(!0)}catch(b){B.error("Error finding similar competitions:",b),h(b.message)}finally{f(!1)}},u=async()=>{f(!0);try{const{error:b}=await _.from("legacy_competitions").update({status:"approved",updated_at:new Date().toISOString()}).eq("id",t.id);if(b)throw b;const{error:s}=await _.from("legacy_results").update({status:"pending",updated_at:new Date().toISOString()}).eq("legacy_competition_id",t.id);if(s)throw s;const{error:w}=await _.from("recalculation_queue").insert([{competition_id:t.id,queued_at:new Date().toISOString()}]).single();if(w&&!w.message.includes("duplicate"))throw w;await g()}catch(b){B.error("Error approving competition:",b),h(b.message)}finally{f(!1)}},x=async b=>{try{if(Object.values(b.fields).some(Boolean)){const w={};Object.entries(b.fields).forEach(([S,A])=>{A&&S!=="results"&&(w[S]=t[S])});const{error:k}=await _.from("legacy_competitions").update(w).eq("id",b.targetId);if(k)throw k}const{error:s}=await _.from("legacy_competitions").update({status:"merged",merged_into_id:b.targetId,merge_notes:b.notes,updated_at:new Date().toISOString()}).eq("id",t.id);if(s)throw s;d(!1),r([]),g()}catch(s){B.error("Error merging competitions:",s),h(s.message)}};return e.jsxs("div",{className:"bg-zinc-800 rounded-lg p-6 mb-6",children:[v&&e.jsx("div",{className:"bg-red-500/20 border border-red-500 text-red-200 p-4 rounded mb-4",children:v}),e.jsxs("div",{className:"flex justify-between items-start mb-4",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"text-xl text-white font-medium",children:[t.name,t.status==="pending"&&e.jsx("span",{className:"ml-2 text-yellow-400 text-sm",children:"(Pending Approval)"})]}),e.jsxs("p",{className:"text-gray-400",children:[t.date&&new Date(t.date).toLocaleDateString("en-GB")," at ",t.venue]}),t.country&&e.jsxs("p",{className:"text-gray-400",children:["Country: ",t.country]}),e.jsxs("p",{className:"text-gray-400 mt-1",children:["Category: ",t.category?e.jsx("span",{className:"capitalize",children:t.category}):"Legacyzz"]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>o(!0),className:"px-4 py-2 bg-black text-white rounded hover:bg-white disabled:opacity-50",disabled:c,children:"Edit Details"}),t.status==="pending"&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:u,className:"px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 disabled:opacity-50",disabled:c,children:c?"Processing...":"Approve Competition"}),e.jsx("button",{onClick:m,className:"px-4 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700 disabled:opacity-50",disabled:c,children:"Check Similar"})]})]})]}),l&&e.jsx(xe,{competition:t,onSave:async b=>{try{const{error:s}=await _.from("legacy_competitions").update(b).eq("id",t.id);if(s)throw s;o(!1),g()}catch(s){h(s.message)}},onCancel:()=>o(!1)}),N&&(a==null?void 0:a.length)>0&&e.jsx(ge,{sourceCompetition:t,targetCompetitions:a,onClose:()=>{d(!1),r([])},onMerge:x}),e.jsxs("div",{className:"mt-6",children:[e.jsx("h4",{className:"text-lg text-white mb-4",children:"Competition Results"}),e.jsx(he,{results:t.legacy_results,competitionStatus:t.status,onResultStatusChange:p})]}),t.status==="approved"&&e.jsx(pe,{competitionId:t.id,results:t.legacy_results,onResolve:g})]})},je=M("CompetitionFilter"),ye=({onFilter:t})=>{const[g,p]=n.useState({name:"",date:"",organizer:null}),[l,o]=n.useState(!1),c=(h,N)=>{p(d=>({...d,[h]:N}))},f=()=>{je.debug("Applying filters:",g),o(!0),t==null||t(g)},v=()=>{const h={name:"",date:"",organizer:null};p(h),o(!1),t==null||t(h)};return e.jsxs("div",{className:"bg-zinc-800 p-4 rounded-lg mb-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-white mb-2",children:"Competition Name"}),e.jsx("input",{type:"text",value:g.name,onChange:h=>c("name",h.target.value),placeholder:"Search by name...",className:"w-full p-2 bg-zinc-700 text-white rounded border border-gray-600"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-white mb-2",children:"Date"}),e.jsx("input",{type:"date",value:g.date,onChange:h=>c("date",h.target.value),className:"w-full p-2 bg-zinc-700 text-white rounded border border-gray-600"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-white mb-2",children:"Organizer"}),e.jsx(le,{onSelect:h=>c("organizer",h),placeholder:"Select organizer..."})]})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[l&&e.jsx("button",{onClick:v,className:"px-4 py-2 bg-zinc-600 hover:bg-zinc-700 text-white rounded",children:"Clear Filters"}),e.jsx("button",{onClick:f,className:"px-4 py-2 bg-black hover:bg-white text-white rounded",children:"Search"})]})]})},ve=M("RatingHistoryViewer"),we=({bartenderId:t,category:g="legacy",showDetails:p=!1})=>{const[l,o]=n.useState([]),[c,f]=n.useState(!0),[v,h]=n.useState(null);if(n.useEffect(()=>{t&&(async()=>{try{let{data:a,error:r}=await _.from("rating_calculations_history").select(`
              id,
              competition_id,
              calculation_time,
              effective_date,
              old_rating,
              new_rating,
              old_rd,
              new_rd,
              old_volatility,
              new_volatility,
              category
            `).eq("bartender_id",t).eq("category",g).order("effective_date",{ascending:!0});if(r)throw r;const m=a.filter(u=>u.competition_id).map(u=>u.competition_id);if(m.length>0){const{data:u,error:x}=await _.from("legacy_competitions").select("id, name, date").in("id",m);if(x)throw x;a=a.map(b=>({...b,competition:u.find(s=>s.id===b.competition_id)}))}o(a||[])}catch(a){ve.error("Error fetching history:",a),h(a.message)}finally{f(!1)}})()},[t,g]),c)return e.jsx("div",{className:"flex justify-center p-4",children:e.jsx("div",{className:"w-6 h-6 border-2 border-blue-600 rounded-full animate-spin"})});if(v)return e.jsx("div",{className:"text-red-500 p-4",children:v});if(!l.length)return e.jsx("div",{className:"text-gray-400 p-4",children:"No rating history available"});const N=new Date;return N.setFullYear(N.getFullYear()-1),e.jsx("div",{className:"overflow-hidden rounded-lg",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-700",children:[e.jsx("thead",{className:"bg-zinc-800",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider",children:"Date"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider",children:"Competition"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider",children:"Rating Change"}),p&&e.jsxs(e.Fragment,{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider",children:"RD"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider",children:"Volatility"})]})]})}),e.jsx("tbody",{className:"divide-y divide-gray-700",children:l.map(d=>{var x;const a=new Date(d.effective_date)<N,r=d.new_rating-d.old_rating,m=d.new_rd-d.old_rd,u=d.new_volatility-d.old_volatility;return e.jsxs("tr",{className:`${a?"opacity-50":""}`,children:[e.jsxs("td",{className:"px-4 py-3 whitespace-nowrap",children:[e.jsx("div",{className:"text-sm text-white",children:d.effective_date?new Date(d.effective_date).toLocaleDateString():"N/A"}),p&&e.jsxs("div",{className:"text-xs text-gray-400",children:["Calculated: ",new Date(d.calculation_time).toLocaleString()]})]}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("div",{className:"text-sm text-white",children:((x=d.competition)==null?void 0:x.name)||"System Update"})}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"flex items-center",children:[e.jsxs("span",{className:`text-sm ${r>0?"text-green-400":r<0?"text-red-400":"text-gray-400"}`,children:[r>0?"+":"",Math.round(r)]}),e.jsx("span",{className:"text-gray-400 mx-2",children:"→"}),e.jsx("span",{className:"text-white",children:Math.round(d.new_rating)})]})}),p&&e.jsxs(e.Fragment,{children:[e.jsx("td",{className:"px-4 py-3 text-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsxs("span",{className:`text-sm ${m<0?"text-green-400":m>0?"text-red-400":"text-gray-400"}`,children:[m<0?"":"+",m.toFixed(1)]}),e.jsx("span",{className:"text-gray-400 mx-2",children:"→"}),e.jsx("span",{className:"text-white",children:d.new_rd.toFixed(1)})]})}),e.jsx("td",{className:"px-4 py-3 text-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsxs("span",{className:`text-sm ${u<0?"text-green-400":u>0?"text-red-400":"text-gray-400"}`,children:[u<0?"":"+",u.toFixed(3)]}),e.jsx("span",{className:"text-gray-400 mx-2",children:"→"}),e.jsx("span",{className:"text-white",children:d.new_volatility.toFixed(3)})]})})]})]},d.id)})})]})})})},te=M("ResultsManagementTab"),se=()=>{const[t,g]=n.useState([]),[p,l]=n.useState(!0),[o,c]=n.useState(null),[f,v]=n.useState({});n.useState(null);const h=async()=>{var d;try{l(!0),c(null);let a=_.from("legacy_competitions").select(`
          id,
          name,
          date,
          venue,
          country,
          status,
          category,
          created_at,
          updated_at,
          created_by,
          updated_by,
          organizer,
          legacy_results (
            id,
            bartender_id,
            placement,
            points,
            status,
            result_source,
            pre_competition_rating,
            post_competition_rating,
            competition_category,
            pre_competition_rd,
            post_competition_rd,
            pre_competition_volatility,
            post_competition_volatility,
            bartenders (
              id,
              full_name
            )
          )
        `).not("status","eq","merged").order("date",{ascending:!1});if(f.name&&(a=a.ilike("name",`%${f.name}%`)),f.date){const x=new Date(f.date).toISOString().split("T")[0];a=a.eq("date",x)}(d=f.organizer)!=null&&d.id&&(a=a.eq("organizer",f.organizer.id));const{data:r,error:m}=await a;if(m)throw m;const u=await Promise.all(r.map(async x=>{if(!x.legacy_results)return x;const b=await Promise.all(x.legacy_results.map(async s=>{const{data:w}=await _.from("rating_calculations_history").select("*").eq("competition_id",x.id).eq("bartender_id",s.bartender_id).eq("category",s.competition_category||"legacy").single();return{...s,rating_history:w}}));return{...x,legacy_results:b}}));g(u)}catch(a){te.error("Error fetching competitions:",a),c(a.message)}finally{l(!1)}};n.useEffect(()=>{h()},[f]);const N=async(d,a)=>{try{const{error:r}=await _.from("legacy_results").update({status:a,updated_at:new Date().toISOString()}).eq("id",d);if(r)throw r;await h()}catch(r){te.error("Error updating result status:",r),c(r.message)}};return p?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin h-8 w-8 border-4 border-blue-500 rounded-full border-t-transparent"})}):e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-white mb-6",children:"Competition Results Management"}),e.jsx(ye,{onFilter:v}),o&&e.jsx("div",{className:"bg-red-500/20 border border-red-500 text-red-200 p-4 rounded mb-6",children:o}),e.jsxs("div",{className:"space-y-6",children:[t.map(d=>e.jsx(be,{competition:d,onUpdate:h,onResultStatusChange:N},d.id)),t.length===0&&e.jsx("div",{className:"text-center text-gray-400 py-8",children:"No competitions found"})]})]})},J=Y("AdminTable"),ae=({sources:t})=>t!=null&&t.length?e.jsx("div",{className:"space-y-1",children:t.map((g,p)=>e.jsx("a",{href:g.url,target:"_blank",rel:"noopener noreferrer",className:"block text-blue-400 hover:text-blue-300 truncate",children:g.url},p))}):e.jsx("span",{className:"text-gray-400",children:"No sources"}),Ne=({tableName:t,showApproveButtons:g=!1,defaultFilters:p={}})=>{const[l,o]=n.useState([]),[c,f]=n.useState(!0),[v,h]=n.useState(null),[N,d]=n.useState(null),[a,r]=n.useState({}),[m,u]=n.useState(p),[x,b]=n.useState({key:"created_at",direction:"desc"}),[s,w]=n.useState({});n.useEffect(()=>{k();const j=S();return()=>j==null?void 0:j.unsubscribe()},[t]);const k=async()=>{try{f(!0);let j=F.from(t).select("*");t==="legacy_competitions"?j=F.from(t).select(`
          *,
          sources (
            id,
            url,
            created_at
          )
        `):t==="legacy_results"&&(j=F.from(t).select(`
          *,
          legacy_competition:legacy_competition_id (
            id,
            name,
            sources (
              id,
              url,
              created_at
            )
          )
        `));const{data:y,error:C}=await j;if(C)throw C;const E={};y&&y.forEach(q=>{var P;q.sources?E[q.id]=q.sources:(P=q.legacy_competition)!=null&&P.sources&&(E[q.id]=q.legacy_competition.sources)}),w(E),o(y||[]),h(null)}catch(j){J.error("Error loading data",j),h(j.message),o([])}finally{f(!1)}},S=()=>F.channel(`${t}_changes`).on("postgres_changes",{event:"*",schema:"public",table:t},()=>k()).subscribe(),A=async j=>{try{const y={...a};delete y.id,delete y.created_at,delete y.updated_at,delete y.sources;const{error:C}=await F.from(t).update(y).eq("id",j);if(C)throw C;await k(),d(null),r({})}catch(y){J.error("Error saving row",y),h(y.message)}},$=async(j,y)=>{try{const{error:C}=await F.from(t).update({status:y}).eq("id",j);if(C)throw C;await k()}catch(C){J.error("Error updating status",C),h(C.message)}},O=n.useMemo(()=>l!=null&&l.length?l.filter(j=>Object.keys(m).every(y=>{if(!m[y])return!0;const C=j[y];return C==null?!1:String(C).toLowerCase().includes(String(m[y]).toLowerCase())})).sort((j,y)=>{if(!x.key)return 0;const C=j[x.key],E=y[x.key];return C===null?1:E===null?-1:x.direction==="asc"?C>E?1:-1:C<E?1:-1}):[],[l,m,x]),H=j=>new Date(j).toLocaleString(),G=(j,y)=>N===j.id?y==="sources"?e.jsx(ae,{sources:s[j.id]}):y==="created_at"||y==="updated_at"?H(j[y]):e.jsx("input",{type:"text",value:a[y]||"",onChange:C=>r(E=>({...E,[y]:C.target.value})),className:"w-full bg-zinc-700 text-white px-2 py-1 rounded"}):y==="sources"?e.jsx(ae,{sources:s[j.id]}):y==="created_at"||y==="updated_at"?H(j[y]):K.isValidElement(j[y])?j[y]:String(j[y]||"");if(c)return e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-white"})});if(!l.length)return e.jsx("div",{className:"text-center p-8 text-gray-400",children:"No data available"});const V=[...Object.keys(l[0]),"sources"];return e.jsxs("div",{children:[v&&e.jsx("div",{className:"bg-red-900/50 border border-red-500 text-white p-4 rounded-lg mb-6",children:v}),e.jsx("div",{className:"bg-zinc-800 rounded-lg shadow-xl",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[V.map(j=>e.jsxs("th",{className:"p-4 text-left",children:[e.jsxs("button",{onClick:()=>b({key:j,direction:x.key===j&&x.direction==="asc"?"desc":"asc"}),className:"flex items-center gap-2 hover:text-blue-400 transition-colors",children:[e.jsx("span",{className:"capitalize",children:j.replace(/_/g," ")}),e.jsx("span",{className:"text-sm opacity-50",children:x.key===j?x.direction==="asc"?"↑":"↓":"↕"})]}),e.jsx("input",{type:"text",placeholder:`Filter ${j}...`,value:m[j]||"",onChange:y=>u(C=>({...C,[j]:y.target.value})),className:"w-full bg-zinc-700 text-white px-2 py-1.5 rounded text-sm border border-gray-600 mt-2"})]},j)),e.jsx("th",{className:"p-4 text-left",children:"Actions"})]})}),e.jsx("tbody",{children:O.map(j=>e.jsxs("tr",{className:"border-t border-gray-700",children:[V.map(y=>e.jsx("td",{className:"p-4",children:G(j,y)},y)),e.jsx("td",{className:"p-4",children:e.jsx("div",{className:"flex gap-2",children:N===j.id?e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>A(j.id),className:"bg-green-600 hover:bg-green-700 px-3 py-1 rounded text-white",children:"Save"}),e.jsx("button",{onClick:()=>{d(null),r({})},className:"bg-zinc-600 hover:bg-zinc-700 px-3 py-1 rounded text-white",children:"Cancel"})]}):e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>{d(j.id),r(j)},className:"bg-black hover:bg-white px-3 py-1 rounded text-white",children:"Edit"}),g&&j.status==="pending"&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>$(j.id,"approved"),className:"bg-green-600 hover:bg-green-700 px-3 py-1 rounded text-white",children:"Approve"}),e.jsx("button",{onClick:()=>$(j.id,"denied"),className:"bg-red-600 hover:bg-red-700 px-3 py-1 rounded text-white",children:"Deny"})]})]})})})]},j.id))})]})})})]})},_e=()=>e.jsx(Ne,{tableName:"organisers"}),U=M("ProfileClaimsTab"),re=({value:t,onChange:g,disabled:p=!1})=>e.jsx("input",{type:"text",value:t||"",onChange:l=>g(l.target.value),disabled:p,className:"w-full bg-zinc-700 text-white focus:outline-none focus:ring-1 focus:ring-blue-500 p-2 rounded disabled:opacity-50"}),Se=()=>{const[t,g]=n.useState([]),[p,l]=n.useState(!0),[o,c]=n.useState(null),[f,v]=n.useState(null),[h,N]=n.useState({}),[d,a]=n.useState({});n.useEffect(()=>{r()},[]);const r=async()=>{try{l(!0);const{data:s,error:w}=await _.from("bartenders").select("*").not("users_attempting_to_claim","eq","{}").not("users_attempting_to_claim","is",null);if(w)throw w;const k=[];for(const S of s||[])if(Array.isArray(S.users_attempting_to_claim)&&S.users_attempting_to_claim.length>0){for(const A of S.users_attempting_to_claim)if(A)try{const{data:$}=await _.from("bartenders").select("*").eq("user_id",A).maybeSingle();$&&k.push({targetProfile:S,claimantProfile:$,submission:{id:`${S.id}-${A}`,user_id:A}})}catch($){U.error(`Error processing claim for user ${A}:`,$)}}g(k),c(null)}catch(s){U.error("Error fetching claims:",s),c(s.message)}finally{l(!1)}},m=async()=>{try{const s=h,w=d,{error:k}=await _.from("bartenders").update({user_id:s.user_id,is_profile_claimed:!0,is_approved:!0,users_attempting_to_claim:[],updated_at:new Date().toISOString()}).eq("id",w.id);if(k)throw k;const{error:S}=await _.from("bartenders").update({is_archived:!0,user_id:null,users_attempting_to_claim:[],updated_at:new Date().toISOString()}).eq("id",s.id);if(S)throw S;await r(),v(null),N({}),a({})}catch(s){U.error("Error accepting claim:",s),c(s.message)}},u=async()=>{try{const s=d,w=h.user_id;if(!s.users_attempting_to_claim)throw new Error("Invalid claim data");const k=s.users_attempting_to_claim.filter(A=>A!==w),{error:S}=await _.from("bartenders").update({users_attempting_to_claim:k,updated_at:new Date().toISOString()}).eq("id",s.id);if(S)throw S;await r(),v(null),N({}),a({})}catch(s){U.error("Error denying claim:",s),c(s.message)}},x=s=>{a(w=>({...w,[s]:h[s]}))},b=(s,w)=>f?e.jsxs("div",{className:"flex gap-4 mb-4 items-center",children:[e.jsx("div",{className:"flex-1 bg-zinc-800 p-2 rounded",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx(re,{value:h[s],onChange:k=>N(S=>({...S,[s]:k}))}),e.jsx("button",{onClick:()=>x(s),className:"text-blue-400 hover:text-blue-300 ml-2 px-2",title:"Copy to right",children:"→"})]})}),e.jsx("div",{className:"text-gray-400 w-24 text-center text-sm",children:w}),e.jsx("div",{className:"flex-1 bg-zinc-800 p-2 rounded",children:e.jsx(re,{value:d[s],onChange:k=>a(S=>({...S,[s]:k}))})})]}):null;return p?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin h-8 w-8 border-4 border-blue-500 rounded-full border-t-transparent"})}):o?e.jsx("div",{className:"p-4 bg-red-900/50 border border-red-500 text-red-200 rounded",children:o}):e.jsxs("div",{className:"p-4",children:[e.jsx("h2",{className:"text-2xl mb-6",children:"Profile Claims"}),f?e.jsxs("div",{children:[e.jsxs("button",{onClick:()=>{v(null),N({}),a({})},className:"mb-4 text-gray-400 hover:text-gray-300 flex items-center gap-2",children:[e.jsx("span",{children:"←"})," Back to claims"]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-xl mb-4",children:"Compare Profiles"}),b("full_name","Name"),b("bar","Bar"),e.jsxs("div",{className:"flex gap-4 mt-8",children:[e.jsx("button",{onClick:u,className:"flex-1 bg-red-600 px-6 py-2 rounded hover:bg-red-700 text-white",children:"Deny Claim"}),e.jsx("button",{onClick:m,className:"flex-1 bg-green-600 px-6 py-2 rounded hover:bg-green-700 text-white",children:"Accept Claim"})]})]})]}):e.jsx("div",{className:"grid gap-4",children:t.length===0?e.jsx("div",{className:"text-gray-400 text-center p-4",children:"No pending profile claims"}):t.map(s=>e.jsxs("div",{className:"bg-zinc-800 p-4 rounded",children:[e.jsxs("div",{className:"flex justify-between mb-2",children:[e.jsxs("div",{children:[e.jsx("strong",{className:"text-white",children:"Claimant: "}),e.jsx("span",{className:"text-gray-300",children:s.claimantProfile.full_name})]}),e.jsxs("div",{children:[e.jsx("strong",{className:"text-white",children:"Target: "}),e.jsx("span",{className:"text-gray-300",children:s.targetProfile.full_name})]})]}),e.jsx("button",{onClick:()=>{v(s),N(s.claimantProfile),a(s.targetProfile)},className:"bg-black px-4 py-2 rounded hover:bg-white text-white",children:"Review"})]},s.submission.id))})]})},Ce=()=>{const[t,g]=n.useState("legacy"),[p,l]=n.useState(!1),[o,c]=n.useState(""),[f,v]=n.useState(null),[h,N]=n.useState([]),[d,a]=n.useState(!0),r=[{id:"legacy",label:"Legacy"},{id:"speed",label:"Speed"},{id:"traditional",label:"Traditional"},{id:"flair",label:"Flair"}],m={legacy:["rating","rating_rd","rating_volatility","ranking"],speed:["speed_rating","speed_rd","speed_volatility","speed_ranking"],traditional:["traditional_rating","traditional_rd","traditional_volatility","traditional_ranking"],flair:["flair_rating","flair_rd","flair_volatility","flair_ranking"]};K.useEffect(()=>{u()},[t]);const u=async()=>{try{const s=m[t],{data:w,error:k}=await _.from("bartenders").select(`
          id,
          full_name,
          ${s.join(",")}
        `).not("is_archived","eq",!0).order(s[3],{ascending:!0,nullsLast:!0});if(k)throw k;N(w||[])}catch(s){c(`Error fetching data: ${s.message}`)}finally{a(!1)}},x=async s=>{l(!0),c(`Resetting ${s} ratings...`);try{const{error:w}=await _.rpc("reset_and_recalculate_category_ratings",{p_category:s,p_process_immediately:!0,p_log_details:!1});if(w)throw w;c(`${s} ratings reset and recalculated successfully`),await u()}catch(w){c(`Error: ${w.message}`)}finally{l(!1)}},b=(s,w)=>{const k=t==="legacy"?"":`${t}_`;return s[`${k}${w}`]||0};return d?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin h-8 w-8 border-4 border-blue-500 rounded-full border-t-transparent"})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("div",{className:"flex gap-2",children:r.map(s=>e.jsx("button",{onClick:()=>g(s.id),className:`px-4 py-2 rounded-lg ${t===s.id?"bg-black text-white":"bg-zinc-700 text-gray-300 hover:bg-zinc-600"}`,children:s.label},s.id))}),e.jsx("button",{onClick:()=>x(t),disabled:p,className:"px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:opacity-50",children:"Reset & Recalculate"})]}),o&&e.jsx("div",{className:`p-4 rounded-lg ${o.includes("Error")?"bg-red-900/50 text-red-200":"bg-green-900/50 text-green-200"}`,children:o}),e.jsx("div",{className:"bg-zinc-800 rounded-lg overflow-hidden",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-700",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase",children:"Rank"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase",children:"Name"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase",children:"Rating"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase",children:"RD"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase",children:"Volatility"}),e.jsx("th",{className:"px-4 py-3"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-700",children:h.map(s=>e.jsxs(K.Fragment,{children:[e.jsxs("tr",{children:[e.jsx("td",{className:"px-4 py-3 text-sm text-gray-300",children:b(s,"ranking")||"Unranked"}),e.jsx("td",{className:"px-4 py-3 text-sm text-white",children:s.full_name}),e.jsx("td",{className:"px-4 py-3 text-sm text-white",children:Math.round(b(s,"rating"))}),e.jsx("td",{className:"px-4 py-3 text-sm text-white",children:b(s,"rd").toFixed(1)}),e.jsx("td",{className:"px-4 py-3 text-sm text-white",children:b(s,"volatility").toFixed(3)}),e.jsx("td",{className:"px-4 py-3 text-sm",children:e.jsx("button",{onClick:()=>v(f===s.id?null:s.id),className:"text-blue-400 hover:text-blue-300",children:f===s.id?"Hide":"History"})})]}),f===s.id&&e.jsx("tr",{children:e.jsx("td",{colSpan:"6",className:"px-4 py-4 bg-gradient-to-b from-zinc-800 to-zinc-900",children:e.jsx(we,{bartenderId:s.id,category:t,showDetails:!0})})})]},s.id))})]})})})]})},ke=()=>{const[t,g]=n.useState("results");n.useEffect(()=>{const l=()=>{const o=window.location.hash.slice(1);o&&g(o.toLowerCase())};return l(),window.addEventListener("hashchange",l),()=>window.removeEventListener("hashchange",l)},[]);const p=()=>{switch(t){case"results":return e.jsx(se,{});case"bartenders":return e.jsx(ue,{});case"organisers":return e.jsx(_e,{});case"profile_claims":return e.jsx(Se,{});case"glicko_ratings":return e.jsx(Ce,{});default:return e.jsx(se,{})}};return e.jsx("div",{className:"min-h-screen bg-gradient-to-b from-zinc-800 to-zinc-900 text-white p-4",children:e.jsxs("div",{className:"max-w-7xl mx-auto",children:[e.jsx("h1",{className:"text-4xl font-bold mb-8",children:"Admin Dashboard"}),e.jsx(de,{activeTab:t,onTabChange:g}),p()]})})},Ee=Y("AdminPage"),Ae=()=>(n.useEffect(()=>{Ee.info("AdminPage mounted (protected)")},[]),e.jsx(ke,{}));export{Ae as default};
